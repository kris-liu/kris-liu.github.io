<!DOCTYPE html><html lang="zh-CN"><head><meta name="google-site-verification" content="DVfrDhwMEodDoWVy6nv0PCpolWhBlGBSaO9hiU2r61E"><meta name="google-site-verification" content="40TgWkMJTOetJQqAMZwk5nD5rtVQRjk5i2pe6FGka5g"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="佑祺's Blog"><title>【转】Unsafe 源码分析 | 佑祺's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-91282031-1','auto');ga('send','pageview');
</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">【转】Unsafe 源码分析</h1><a id="logo" href="/.">佑祺's Blog</a><p class="description">Whatever you do, you have to keep moving forward!</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">【转】Unsafe 源码分析</h1><div class="post-meta">Nov 17, 2016<span> | </span><span class="category"><a href="/categories/Java/">Java</a></span></div><div class="post-content"><p>【转】：<a href="http://www.cnblogs.com/mickole/articles/3757278.html" target="_blank" rel="external">http://www.cnblogs.com/mickole/articles/3757278.html</a></p>
<h2 id="sun-misc-Unsafe"><a href="#sun-misc-Unsafe" class="headerlink" title="sun.misc.Unsafe"></a>sun.misc.Unsafe</h2><a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * This class should provide access to low-level operations and its</div><div class="line"> * use should be limited to trusted code.  Fields can be accessed using</div><div class="line"> * memory addresses, with undefined behaviour occurring if invalid memory</div><div class="line"> * addresses are given.</div><div class="line"> * 这个类提供了一个更底层的操作并且应该在受信任的代码中使用。可以通过内存地址</div><div class="line"> * 存取fields,如果给出的内存地址是无效的那么会有一个不确定的运行表现。</div><div class="line"> *</div><div class="line"> * @author Tom Tromey (tromey@redhat.com)</div><div class="line"> * @author Andrew John Hughes (gnu_andrew@member.fsf.org)</div><div class="line"> */</div><div class="line">public class Unsafe &#123;</div><div class="line">    // Singleton class.</div><div class="line">    private static Unsafe unsafe = new Unsafe();</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Private default constructor to prevent creation of an arbitrary</div><div class="line">     * number of instances.</div><div class="line">     * 使用私有默认构造器防止创建多个实例</div><div class="line">     */</div><div class="line">    private Unsafe() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Retrieve the singleton instance of &lt;code&gt;Unsafe&lt;/code&gt;.  The calling</div><div class="line">     * method should guard this instance from untrusted code, as it provides</div><div class="line">     * access to low-level operations such as direct memory access.</div><div class="line">     * 获取&lt;code&gt;Unsafe&lt;/code&gt;的单例,这个方法调用应该防止在不可信的代码中实例，</div><div class="line">     * 因为unsafe类提供了一个低级别的操作，例如直接内存存取。</div><div class="line">     *</div><div class="line">     * @throws SecurityException if a security manager exists and prevents</div><div class="line">     *                           access to the system properties.</div><div class="line">     *                           如果安全管理器不存在或者禁止访问系统属性</div><div class="line">     */</div><div class="line">    public static Unsafe getUnsafe() &#123;</div><div class="line">        SecurityManager sm = System.getSecurityManager();</div><div class="line">        if (sm != null)</div><div class="line">            sm.checkPropertiesAccess();</div><div class="line">        return unsafe;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Returns the memory address offset of the given static field.</div><div class="line">     * The offset is merely used as a means to access a particular field</div><div class="line">     * in the other methods of this class.  The value is unique to the given</div><div class="line">     * field and the same value should be returned on each subsequent call.</div><div class="line">     * 返回指定静态field的内存地址偏移量,在这个类的其他方法中这个值只是被用作一个访问</div><div class="line">     * 特定field的一个方式。这个值对于 给定的field是唯一的，并且后续对该方法的调用都应该</div><div class="line">     * 返回相同的值。</div><div class="line">     *</div><div class="line">     * @param field the field whose offset should be returned.</div><div class="line">     *              需要返回偏移量的field</div><div class="line">     * @return the offset of the given field.</div><div class="line">     *         指定field的偏移量</div><div class="line">     */</div><div class="line">    public native long objectFieldOffset(Field field);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Compares the value of the integer field at the specified offset</div><div class="line">     * in the supplied object with the given expected value, and updates</div><div class="line">     * it if they match.  The operation of this method should be atomic,</div><div class="line">     * thus providing an uninterruptible way of updating an integer field.</div><div class="line">     * 在obj的offset位置比较integer field和期望的值，如果相同则更新。这个方法</div><div class="line">     * 的操作应该是原子的，因此提供了一种不可中断的方式更新integer field。</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to modify.</div><div class="line">     *               包含要修改field的对象</div><div class="line">     * @param offset the offset of the integer field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中整型field的偏移量</div><div class="line">     * @param expect the expected value of the field.</div><div class="line">     *               希望field中存在的值</div><div class="line">     * @param update the new value of the field if it equals &lt;code&gt;expect&lt;/code&gt;.</div><div class="line">     *               如果期望值expect与field的当前值相同，设置filed的值为这个新值</div><div class="line">     * @return true if the field was changed.</div><div class="line">     *         如果field的值被更改</div><div class="line">     */</div><div class="line">    public native boolean compareAndSwapInt(Object obj, long offset,</div><div class="line">                                            int expect, int update);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Compares the value of the long field at the specified offset</div><div class="line">     * in the supplied object with the given expected value, and updates</div><div class="line">     * it if they match.  The operation of this method should be atomic,</div><div class="line">     * thus providing an uninterruptible way of updating a long field.</div><div class="line">     * 在obj的offset位置比较long field和期望的值，如果相同则更新。这个方法</div><div class="line">     * 的操作应该是原子的，因此提供了一种不可中断的方式更新long field。</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to modify.</div><div class="line">     *               包含要修改field的对象</div><div class="line">     * @param offset the offset of the long field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中long型field的偏移量</div><div class="line">     * @param expect the expected value of the field.</div><div class="line">     *               希望field中存在的值</div><div class="line">     * @param update the new value of the field if it equals &lt;code&gt;expect&lt;/code&gt;.</div><div class="line">     *               如果期望值expect与field的当前值相同，设置filed的值为这个新值</div><div class="line">     * @return true if the field was changed.</div><div class="line">     *         如果field的值被更改</div><div class="line">     */</div><div class="line">    public native boolean compareAndSwapLong(Object obj, long offset,</div><div class="line">                                             long expect, long update);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Compares the value of the object field at the specified offset</div><div class="line">     * in the supplied object with the given expected value, and updates</div><div class="line">     * it if they match.  The operation of this method should be atomic,</div><div class="line">     * thus providing an uninterruptible way of updating an object field.</div><div class="line">     * 在obj的offset位置比较object field和期望的值，如果相同则更新。这个方法</div><div class="line">     * 的操作应该是原子的，因此提供了一种不可中断的方式更新object field。</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to modify.</div><div class="line">     *               包含要修改field的对象</div><div class="line">     * @param offset the offset of the object field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中object型field的偏移量</div><div class="line">     * @param expect the expected value of the field.</div><div class="line">     *               希望field中存在的值</div><div class="line">     * @param update the new value of the field if it equals &lt;code&gt;expect&lt;/code&gt;.</div><div class="line">     *               如果期望值expect与field的当前值相同，设置filed的值为这个新值</div><div class="line">     * @return true if the field was changed.</div><div class="line">     *         如果field的值被更改</div><div class="line">     */</div><div class="line">    public native boolean compareAndSwapObject(Object obj, long offset,</div><div class="line">                                               Object expect, Object update);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Sets the value of the integer field at the specified offset in the</div><div class="line">     * supplied object to the given value.  This is an ordered or lazy</div><div class="line">     * version of &lt;code&gt;putIntVolatile(Object,long,int)&lt;/code&gt;, which</div><div class="line">     * doesn&apos;t guarantee the immediate visibility of the change to other</div><div class="line">     * threads.  It is only really useful where the integer field is</div><div class="line">     * &lt;code&gt;volatile&lt;/code&gt;, and is thus expected to change unexpectedly.</div><div class="line">     * 设置obj对象中offset偏移地址对应的整型field的值为指定值。这是一个有序或者</div><div class="line">     * 有延迟的&lt;code&gt;putIntVolatile&lt;/cdoe&gt;方法，并且不保证值的改变被其他线程立</div><div class="line">     * 即看到。只有在field被&lt;code&gt;volatile&lt;/code&gt;修饰并且期望被意外修改的时候</div><div class="line">     * 使用才有用。</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to modify.</div><div class="line">     *               包含需要修改field的对象</div><div class="line">     * @param offset the offset of the integer field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中整型field的偏移量</div><div class="line">     * @param value  the new value of the field.</div><div class="line">     *               field将被设置的新值</div><div class="line">     * @see #putIntVolatile(Object, long, int)</div><div class="line">     */</div><div class="line">    public native void putOrderedInt(Object obj, long offset, int value);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Sets the value of the long field at the specified offset in the</div><div class="line">     * supplied object to the given value.  This is an ordered or lazy</div><div class="line">     * version of &lt;code&gt;putLongVolatile(Object,long,long)&lt;/code&gt;, which</div><div class="line">     * doesn&apos;t guarantee the immediate visibility of the change to other</div><div class="line">     * threads.  It is only really useful where the long field is</div><div class="line">     * &lt;code&gt;volatile&lt;/code&gt;, and is thus expected to change unexpectedly.</div><div class="line">     * 设置obj对象中offset偏移地址对应的long型field的值为指定值。这是一个有序或者</div><div class="line">     * 有延迟的&lt;code&gt;putLongVolatile&lt;/cdoe&gt;方法，并且不保证值的改变被其他线程立</div><div class="line">     * 即看到。只有在field被&lt;code&gt;volatile&lt;/code&gt;修饰并且期望被意外修改的时候</div><div class="line">     * 使用才有用。</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to modify.</div><div class="line">     *               包含需要修改field的对象</div><div class="line">     * @param offset the offset of the long field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中long型field的偏移量</div><div class="line">     * @param value  the new value of the field.</div><div class="line">     *               field将被设置的新值</div><div class="line">     * @see #putLongVolatile(Object, long, long)</div><div class="line">     */</div><div class="line">    public native void putOrderedLong(Object obj, long offset, long value);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Sets the value of the object field at the specified offset in the</div><div class="line">     * supplied object to the given value.  This is an ordered or lazy</div><div class="line">     * version of &lt;code&gt;putObjectVolatile(Object,long,Object)&lt;/code&gt;, which</div><div class="line">     * doesn&apos;t guarantee the immediate visibility of the change to other</div><div class="line">     * threads.  It is only really useful where the object field is</div><div class="line">     * &lt;code&gt;volatile&lt;/code&gt;, and is thus expected to change unexpectedly.</div><div class="line">     * 设置obj对象中offset偏移地址对应的object型field的值为指定值。这是一个有序或者</div><div class="line">     * 有延迟的&lt;code&gt;putObjectVolatile&lt;/cdoe&gt;方法，并且不保证值的改变被其他线程立</div><div class="line">     * 即看到。只有在field被&lt;code&gt;volatile&lt;/code&gt;修饰并且期望被意外修改的时候</div><div class="line">     * 使用才有用。</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to modify.</div><div class="line">     *               包含需要修改field的对象</div><div class="line">     * @param offset the offset of the object field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中long型field的偏移量</div><div class="line">     * @param value  the new value of the field.</div><div class="line">     *               field将被设置的新值</div><div class="line">     */</div><div class="line">    public native void putOrderedObject(Object obj, long offset, Object value);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Sets the value of the integer field at the specified offset in the</div><div class="line">     * supplied object to the given value, with volatile store semantics.</div><div class="line">     * 设置obj对象中offset偏移地址对应的整型field的值为指定值。支持volatile store语义</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to modify.</div><div class="line">     *               包含需要修改field的对象</div><div class="line">     * @param offset the offset of the integer field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中整型field的偏移量</div><div class="line">     * @param value  the new value of the field.</div><div class="line">     *               field将被设置的新值</div><div class="line">     */</div><div class="line">    public native void putIntVolatile(Object obj, long offset, int value);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Retrieves the value of the integer field at the specified offset in the</div><div class="line">     * supplied object with volatile load semantics.</div><div class="line">     * 获取obj对象中offset偏移地址对应的整型field的值,支持volatile load语义。</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to read.</div><div class="line">     *               包含需要去读取的field的对象</div><div class="line">     * @param offset the offset of the integer field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中整型field的偏移量</div><div class="line">     */</div><div class="line">    public native int getIntVolatile(Object obj, long offset);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Sets the value of the long field at the specified offset in the</div><div class="line">     * supplied object to the given value, with volatile store semantics.</div><div class="line">     * 设置obj对象中offset偏移地址对应的long型field的值为指定值。支持volatile store语义</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to modify.</div><div class="line">     *               包含需要修改field的对象</div><div class="line">     * @param offset the offset of the long field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中long型field的偏移量</div><div class="line">     * @param value  the new value of the field.</div><div class="line">     *               field将被设置的新值</div><div class="line">     * @see #putLong(Object, long, long)</div><div class="line">     */</div><div class="line">    public native void putLongVolatile(Object obj, long offset, long value);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Sets the value of the long field at the specified offset in the</div><div class="line">     * supplied object to the given value.</div><div class="line">     * 设置obj对象中offset偏移地址对应的long型field的值为指定值。</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to modify.</div><div class="line">     *               包含需要修改field的对象</div><div class="line">     * @param offset the offset of the long field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中long型field的偏移量</div><div class="line">     * @param value  the new value of the field.</div><div class="line">     *               field将被设置的新值</div><div class="line">     * @see #putLongVolatile(Object, long, long)</div><div class="line">     */</div><div class="line">    public native void putLong(Object obj, long offset, long value);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Retrieves the value of the long field at the specified offset in the</div><div class="line">     * supplied object with volatile load semantics.</div><div class="line">     * 获取obj对象中offset偏移地址对应的long型field的值,支持volatile load语义。</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to read.</div><div class="line">     *               包含需要去读取的field的对象</div><div class="line">     * @param offset the offset of the long field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中long型field的偏移量</div><div class="line">     * @see #getLong(Object, long)</div><div class="line">     */</div><div class="line">    public native long getLongVolatile(Object obj, long offset);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Retrieves the value of the long field at the specified offset in the</div><div class="line">     * supplied object.</div><div class="line">     * 获取obj对象中offset偏移地址对应的long型field的值</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to read.</div><div class="line">     *               包含需要去读取的field的对象</div><div class="line">     * @param offset the offset of the long field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中long型field的偏移量</div><div class="line">     * @see #getLongVolatile(Object, long)</div><div class="line">     */</div><div class="line">    public native long getLong(Object obj, long offset);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Sets the value of the object field at the specified offset in the</div><div class="line">     * supplied object to the given value, with volatile store semantics.</div><div class="line">     * 设置obj对象中offset偏移地址对应的object型field的值为指定值。支持volatile store语义</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to modify.</div><div class="line">     *               包含需要修改field的对象</div><div class="line">     * @param offset the offset of the object field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中object型field的偏移量</div><div class="line">     * @param value  the new value of the field.</div><div class="line">     *               field将被设置的新值</div><div class="line">     * @see #putObject(Object, long, Object)</div><div class="line">     */</div><div class="line">    public native void putObjectVolatile(Object obj, long offset, Object value);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Sets the value of the object field at the specified offset in the</div><div class="line">     * supplied object to the given value.</div><div class="line">     * 设置obj对象中offset偏移地址对应的object型field的值为指定值。</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to modify.</div><div class="line">     *               包含需要修改field的对象</div><div class="line">     * @param offset the offset of the object field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中object型field的偏移量</div><div class="line">     * @param value  the new value of the field.</div><div class="line">     *               field将被设置的新值</div><div class="line">     * @see #putObjectVolatile(Object, long, Object)</div><div class="line">     */</div><div class="line">    public native void putObject(Object obj, long offset, Object value);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Retrieves the value of the object field at the specified offset in the</div><div class="line">     * supplied object with volatile load semantics.</div><div class="line">     * 获取obj对象中offset偏移地址对应的object型field的值,支持volatile load语义。</div><div class="line">     *</div><div class="line">     * @param obj    the object containing the field to read.</div><div class="line">     *               包含需要去读取的field的对象</div><div class="line">     * @param offset the offset of the object field within &lt;code&gt;obj&lt;/code&gt;.</div><div class="line">     *               &lt;code&gt;obj&lt;/code&gt;中object型field的偏移量</div><div class="line">     */</div><div class="line">    public native Object getObjectVolatile(Object obj, long offset);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Returns the offset of the first element for a given array class.</div><div class="line">     * To access elements of the array class, this value may be used along with</div><div class="line">     * with that returned by</div><div class="line">     * &lt;a href=&quot;#arrayIndexScale&quot;&gt;&lt;code&gt;arrayIndexScale&lt;/code&gt;&lt;/a&gt;,</div><div class="line">     * if non-zero.</div><div class="line">     * 获取给定数组中第一个元素的偏移地址。</div><div class="line">     * 为了存取数组中的元素，这个偏移地址与&lt;a href=&quot;#arrayIndexScale&quot;&gt;&lt;code&gt;arrayIndexScale</div><div class="line">     * &lt;/code&gt;&lt;/a&gt;方法的非0返回值一起被使用。</div><div class="line">     *</div><div class="line">     * @param arrayClass the class for which the first element&apos;s address should</div><div class="line">     *                   be obtained.</div><div class="line">     *                   第一个元素地址被获取的class</div><div class="line">     * @return the offset of the first element of the array class.</div><div class="line">     *         数组第一个元素 的偏移地址</div><div class="line">     * @see arrayIndexScale(Class)</div><div class="line">     */</div><div class="line">    public native int arrayBaseOffset(Class arrayClass);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Returns the scale factor used for addressing elements of the supplied</div><div class="line">     * array class.  Where a suitable scale factor can not be returned (e.g.</div><div class="line">     * for primitive types), zero should be returned.  The returned value</div><div class="line">     * can be used with</div><div class="line">     * &lt;a href=&quot;#arrayBaseOffset&quot;&gt;&lt;code&gt;arrayBaseOffset&lt;/code&gt;&lt;/a&gt;</div><div class="line">     * to access elements of the class.</div><div class="line">     * 获取用户给定数组寻址的换算因子.一个合适的换算因子不能返回的时候(例如：基本类型),</div><div class="line">     * 返回0.这个返回值能够与&lt;a href=&quot;#arrayBaseOffset&quot;&gt;&lt;code&gt;arrayBaseOffset&lt;/code&gt;</div><div class="line">     * &lt;/a&gt;一起使用去存取这个数组class中的元素</div><div class="line">     *</div><div class="line">     * @param arrayClass the class whose scale factor should be returned.</div><div class="line">     * @return the scale factor, or zero if not supported for this array class.</div><div class="line">     */</div><div class="line">    public native int arrayIndexScale(Class arrayClass);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Releases the block on a thread created by</div><div class="line">     * &lt;a href=&quot;#park&quot;&gt;&lt;code&gt;park&lt;/code&gt;&lt;/a&gt;.  This method can also be used</div><div class="line">     * to terminate a blockage caused by a prior call to &lt;code&gt;park&lt;/code&gt;.</div><div class="line">     * This operation is unsafe, as the thread must be guaranteed to be</div><div class="line">     * live.  This is true of Java, but not native code.</div><div class="line">     * 释放被&lt;a href=&quot;#park&quot;&gt;&lt;code&gt;park&lt;/code&gt;&lt;/a&gt;创建的在一个线程上的阻塞.这个</div><div class="line">     * 方法也可以被使用来终止一个先前调用&lt;code&gt;park&lt;/code&gt;导致的阻塞.</div><div class="line">     * 这个操作操作时不安全的,因此线程必须保证是活的.这是java代码不是native代码。</div><div class="line">     *</div><div class="line">     * @param thread the thread to unblock.</div><div class="line">     *               要解除阻塞的线程</div><div class="line">     */</div><div class="line">    public native void unpark(Thread thread);</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Blocks the thread until a matching</div><div class="line">     * &lt;a href=&quot;#unpark&quot;&gt;&lt;code&gt;unpark&lt;/code&gt;&lt;/a&gt; occurs, the thread is</div><div class="line">     * interrupted or the optional timeout expires.  If an &lt;code&gt;unpark&lt;/code&gt;</div><div class="line">     * call has already occurred, this also counts.  A timeout value of zero</div><div class="line">     * is defined as no timeout.  When &lt;code&gt;isAbsolute&lt;/code&gt; is</div><div class="line">     * &lt;code&gt;true&lt;/code&gt;, the timeout is in milliseconds relative to the</div><div class="line">     * epoch.  Otherwise, the value is the number of nanoseconds which must</div><div class="line">     * occur before timeout.  This call may also return spuriously (i.e.</div><div class="line">     * for no apparent reason).</div><div class="line">     * 阻塞一个线程直到&lt;a href=&quot;#unpark&quot;&gt;&lt;code&gt;unpark&lt;/code&gt;&lt;/a&gt;出现、线程</div><div class="line">     * 被中断或者timeout时间到期。如果一个&lt;code&gt;unpark&lt;/code&gt;调用已经出现了，</div><div class="line">     * 这里只计数。timeout为0表示永不过期.当&lt;code&gt;isAbsolute&lt;/code&gt;为true时，</div><div class="line">     * timeout是相对于新纪元之后的毫秒。否则这个值就是超时前的纳秒数。这个方法执行时</div><div class="line">     * 也可能不合理地返回(没有具体原因)</div><div class="line">     *</div><div class="line">     * @param isAbsolute true if the timeout is specified in milliseconds from</div><div class="line">     *                   the epoch.</div><div class="line">     *                   如果为true timeout的值是一个相对于新纪元之后的毫秒数</div><div class="line">     * @param time       either the number of nanoseconds to wait, or a time in</div><div class="line">     *                   milliseconds from the epoch to wait for.</div><div class="line">     *                   可以是一个要等待的纳秒数，或者是一个相对于新纪元之后的毫秒数直到</div><div class="line">     *                   到达这个时间点</div><div class="line">     */</div><div class="line">    public native void park(boolean isAbsolute, long time);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="sun-misc-natUnsafe-cc源码"><a href="#sun-misc-natUnsafe-cc源码" class="headerlink" title="sun.misc.natUnsafe.cc源码"></a>sun.misc.natUnsafe.cc源码</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div></pre></td><td class="code"><pre><div class="line">#include &lt;gcj/cni.h&gt;</div><div class="line">#include &lt;gcj/field.h&gt;</div><div class="line">#include &lt;gcj/javaprims.h&gt;</div><div class="line">#include &lt;jvm.h&gt;</div><div class="line">#include &lt;sun/misc/Unsafe.h&gt;</div><div class="line">#include &lt;java/lang/System.h&gt;</div><div class="line">#include &lt;java/lang/InterruptedException.h&gt;</div><div class="line"> </div><div class="line">#include &lt;java/lang/Thread.h&gt;</div><div class="line">#include &lt;java/lang/Long.h&gt;</div><div class="line"> </div><div class="line">#include &quot;sysdep/locks.h&quot;</div><div class="line"> </div><div class="line">// Use a spinlock for multi-word accesses</div><div class="line">class spinlock</div><div class="line">&#123;</div><div class="line">  static volatile obj_addr_t lock;</div><div class="line"> </div><div class="line">public:</div><div class="line"> </div><div class="line">spinlock ()</div><div class="line">  &#123;</div><div class="line">    while (! compare_and_swap (&amp;lock, 0, 1))</div><div class="line">      _Jv_ThreadYield ();</div><div class="line">  &#125;</div><div class="line">  ~spinlock ()</div><div class="line">  &#123;</div><div class="line">    release_set (&amp;lock, 0);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"> </div><div class="line">// This is a single lock that is used for all synchronized accesses if</div><div class="line">// the compiler can&apos;t generate inline compare-and-swap operations.  In</div><div class="line">// most cases it&apos;ll never be used, but the i386 needs it for 64-bit</div><div class="line">// locked accesses and so does PPC32.  It&apos;s worth building libgcj with</div><div class="line">// target=i486 (or above) to get the inlines.</div><div class="line">volatile obj_addr_t spinlock::lock;</div><div class="line"> </div><div class="line"> </div><div class="line">static inline bool</div><div class="line">compareAndSwap (volatile jint *addr, jint old, jint new_val)</div><div class="line">&#123;</div><div class="line">  jboolean result = false;</div><div class="line">  spinlock lock;</div><div class="line">  if ((result = (*addr == old)))</div><div class="line">    *addr = new_val;</div><div class="line">  return result;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">static inline bool</div><div class="line">compareAndSwap (volatile jlong *addr, jlong old, jlong new_val)</div><div class="line">&#123;</div><div class="line">  jboolean result = false;</div><div class="line">  spinlock lock;</div><div class="line">  if ((result = (*addr == old)))</div><div class="line">    *addr = new_val;</div><div class="line">  return result;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">static inline bool</div><div class="line">compareAndSwap (volatile jobject *addr, jobject old, jobject new_val)</div><div class="line">&#123;</div><div class="line">  jboolean result = false;</div><div class="line">  spinlock lock;</div><div class="line">  if ((result = (*addr == old)))</div><div class="line">    *addr = new_val;</div><div class="line">  return result;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"> </div><div class="line">jlong</div><div class="line">sun::misc::Unsafe::objectFieldOffset (::java::lang::reflect::Field *field)</div><div class="line">&#123;</div><div class="line">  _Jv_Field *fld = _Jv_FromReflectedField (field);</div><div class="line">  // FIXME: what if it is not an instance field?</div><div class="line">  return fld-&gt;getOffset();</div><div class="line">&#125;</div><div class="line"> </div><div class="line">jint</div><div class="line">sun::misc::Unsafe::arrayBaseOffset (jclass arrayClass)</div><div class="line">&#123;</div><div class="line">  // FIXME: assert that arrayClass is array.</div><div class="line">  jclass eltClass = arrayClass-&gt;getComponentType();</div><div class="line">  return (jint)(jlong) _Jv_GetArrayElementFromElementType (NULL, eltClass);</div><div class="line">&#125;</div><div class="line"> </div><div class="line">jint</div><div class="line">sun::misc::Unsafe::arrayIndexScale (jclass arrayClass)</div><div class="line">&#123;</div><div class="line">  // FIXME: assert that arrayClass is array.</div><div class="line">  jclass eltClass = arrayClass-&gt;getComponentType();</div><div class="line">  if (eltClass-&gt;isPrimitive())</div><div class="line">    return eltClass-&gt;size();</div><div class="line">  return sizeof (void *);</div><div class="line">&#125;</div><div class="line"> </div><div class="line">// These methods are used when the compiler fails to generate inline</div><div class="line">// versions of the compare-and-swap primitives.</div><div class="line"> </div><div class="line">jboolean</div><div class="line">sun::misc::Unsafe::compareAndSwapInt (jobject obj, jlong offset,</div><div class="line">                                           jint expect, jint update)</div><div class="line">&#123;</div><div class="line">  jint *addr = (jint *)((char *)obj + offset);</div><div class="line">  return compareAndSwap (addr, expect, update);</div><div class="line">&#125;</div><div class="line"> </div><div class="line">jboolean</div><div class="line">sun::misc::Unsafe::compareAndSwapLong (jobject obj, jlong offset,</div><div class="line">                                            jlong expect, jlong update)</div><div class="line">&#123;</div><div class="line">  volatile jlong *addr = (jlong*)((char *) obj + offset);</div><div class="line">  return compareAndSwap (addr, expect, update);</div><div class="line">&#125;</div><div class="line"> </div><div class="line">jboolean</div><div class="line">sun::misc::Unsafe::compareAndSwapObject (jobject obj, jlong offset,</div><div class="line">                                                jobject expect, jobject update)</div><div class="line">&#123;</div><div class="line">  jobject *addr = (jobject*)((char *) obj + offset);</div><div class="line">  return compareAndSwap (addr, expect, update);</div><div class="line">&#125;</div><div class="line"> </div><div class="line">void</div><div class="line">sun::misc::Unsafe::putOrderedInt (jobject obj, jlong offset, jint value)</div><div class="line">&#123;</div><div class="line">  volatile jint *addr = (jint *) ((char *) obj + offset);</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">void</div><div class="line">sun::misc::Unsafe::putOrderedLong (jobject obj, jlong offset, jlong value)</div><div class="line">&#123;</div><div class="line">  volatile jlong *addr = (jlong *) ((char *) obj + offset);</div><div class="line">  spinlock lock;</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">void</div><div class="line">sun::misc::Unsafe::putOrderedObject (jobject obj, jlong offset, jobject value)</div><div class="line">&#123;</div><div class="line">  volatile jobject *addr = (jobject *) ((char *) obj + offset);</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">void</div><div class="line">sun::misc::Unsafe::putIntVolatile (jobject obj, jlong offset, jint value)</div><div class="line">&#123;</div><div class="line">  write_barrier ();</div><div class="line">  volatile jint *addr = (jint *) ((char *) obj + offset);</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">void</div><div class="line">sun::misc::Unsafe::putLongVolatile (jobject obj, jlong offset, jlong value)</div><div class="line">&#123;</div><div class="line">  volatile jlong *addr = (jlong *) ((char *) obj + offset);</div><div class="line">  spinlock lock;</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">void</div><div class="line">sun::misc::Unsafe::putObjectVolatile (jobject obj, jlong offset, jobject value)</div><div class="line">&#123;</div><div class="line">  write_barrier ();</div><div class="line">  volatile jobject *addr = (jobject *) ((char *) obj + offset);</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">#if 0  // FIXME</div><div class="line">void</div><div class="line">sun::misc::Unsafe::putInt (jobject obj, jlong offset, jint value)</div><div class="line">&#123;</div><div class="line">  jint *addr = (jint *) ((char *) obj + offset);</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line">#endif</div><div class="line"> </div><div class="line">void</div><div class="line">sun::misc::Unsafe::putLong (jobject obj, jlong offset, jlong value)</div><div class="line">&#123;</div><div class="line">  jlong *addr = (jlong *) ((char *) obj + offset);</div><div class="line">  spinlock lock;</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">void</div><div class="line">sun::misc::Unsafe::putObject (jobject obj, jlong offset, jobject value)</div><div class="line">&#123;</div><div class="line">  jobject *addr = (jobject *) ((char *) obj + offset);</div><div class="line">  *addr = value;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">jint</div><div class="line">sun::misc::Unsafe::getIntVolatile (jobject obj, jlong offset)</div><div class="line">&#123;</div><div class="line">  volatile jint *addr = (jint *) ((char *) obj + offset);</div><div class="line">  jint result = *addr;</div><div class="line">  read_barrier ();</div><div class="line">  return result;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">jobject</div><div class="line">sun::misc::Unsafe::getObjectVolatile (jobject obj, jlong offset)</div><div class="line">&#123;</div><div class="line">  volatile jobject *addr = (jobject *) ((char *) obj + offset);</div><div class="line">  jobject result = *addr;</div><div class="line">  read_barrier ();</div><div class="line">  return result;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">jlong</div><div class="line">sun::misc::Unsafe::getLong (jobject obj, jlong offset)</div><div class="line">&#123;</div><div class="line">  jlong *addr = (jlong *) ((char *) obj + offset);</div><div class="line">  spinlock lock;</div><div class="line">  return *addr;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">jlong</div><div class="line">sun::misc::Unsafe::getLongVolatile (jobject obj, jlong offset)</div><div class="line">&#123;</div><div class="line">  volatile jlong *addr = (jlong *) ((char *) obj + offset);</div><div class="line">  spinlock lock;</div><div class="line">  return *addr;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">void</div><div class="line">sun::misc::Unsafe::unpark (::java::lang::Thread *thread)</div><div class="line">&#123;</div><div class="line">  natThread *nt = (natThread *) thread-&gt;data;</div><div class="line">  nt-&gt;park_helper.unpark ();</div><div class="line">&#125;</div><div class="line"> </div><div class="line">void</div><div class="line">sun::misc::Unsafe::park (jboolean isAbsolute, jlong time)</div><div class="line">&#123;</div><div class="line">  using namespace ::java::lang;</div><div class="line">  Thread *thread = Thread::currentThread();</div><div class="line">  natThread *nt = (natThread *) thread-&gt;data;</div><div class="line">  nt-&gt;park_helper.park (isAbsolute, time);</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="http://blogxin.cn/2016/11/17/Unsafe-源码分析/" data-id="cjn1wa3xi002rt16z4pt49ypz" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACL0lEQVR42u3aQY6DMAwF0N7/0ow02xnCt91WIrysUFGLHwvXif16xev4Xcnd9fXZ7xx/1usTCwMD47aMY7nOGD3Y+pOz565jw8DAeA6jGko1rHXyTa4vYsbAwMAohjJPvhgYGBiThJsUcL09JgYGBsaakRdz+UY3LwSTu2/bi2NgYNyQUW0MfPP6g/0NDAyMmzCO1qo2O3uJuxAPBgbG1oxkDCLJcr3NZ9JsKCRiDAyMTRmTo/x5TZqPXFwgMTAwtmasE+68EFwHN0/K0f8GBgbGzRn5OFcybNEb0ciLwtNnYWBgPIbRC/FdR//J6MZFDxYDA2NrRpL+epi8Pk22yhd7cQwMjEcyeiFWk2z1pVx0YjEwMDZlJKFMgk6O26pDHv+0BDAwMB7ASI7JkoO5/KVMWhGnCRcDA2M7Ru8LvSHX6kupFpoYGBjPYVRbAtVDtGqrspmaMTAwNmJUG4e9YjEvB/Oy76LCxcDA2IgxPxqbtCeT1JwXixgYGHszJoXaZKNb/VY0ioGBgbEpozoGkWwvq+Vd/sTRZBkGBsZGjLxom5Rx5f+EdQwYGBhbM941bDFpf77iVUi7GBgYWzDmW818qGKyAb74NQwMjK0ZvTSXl5LzEQ0MDAyM/Di+dxCWNybzshIDA+PJjF6SnRzr94Y2opkRDAwMjOJWttcMyAcvMDAwMJLH90rGLw1bYGBgbMTojZb20mWeRgsYDAyMrRnf7DlUX0SzTMTAwNiH8QPKsyLgppVmhAAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/Java/">Java</a><a href="/tags/源码/">源码</a></div><div class="post-nav"><a class="pre" href="/2016/11/18/ThreadLocal-源码分析/">ThreadLocal 源码分析</a><a class="next" href="/2016/11/15/Java-Cache-Line-伪共享及解决方案/">Java Cache Line 伪共享及解决方案</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '530c0141e83989b1dc02',
  clientSecret: '89e61ba0adc9b0c630bcc2641c791bfd7ef9faea',
  repo: 'kris-liu.github.io',
  owner: 'kris-liu',
  admin: ['kris-liu'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://blogxin.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Concurrent/">Concurrent</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/IO-NIO/">IO&NIO</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/线上问题/">线上问题</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/源码/" style="font-size: 15px;">源码</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/MQ/" style="font-size: 15px;">MQ</a> <a href="/tags/架构/" style="font-size: 15px;">架构</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/线上问题/" style="font-size: 15px;">线上问题</a> <a href="/tags/IO/" style="font-size: 15px;">IO</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/锁/" style="font-size: 15px;">锁</a> <a href="/tags/Transaction/" style="font-size: 15px;">Transaction</a> <a href="/tags/内存泄漏/" style="font-size: 15px;">内存泄漏</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/异步/" style="font-size: 15px;">异步</a> <a href="/tags/读写锁/" style="font-size: 15px;">读写锁</a> <a href="/tags/缓存/" style="font-size: 15px;">缓存</a> <a href="/tags/线程池/" style="font-size: 15px;">线程池</a> <a href="/tags/BIO/" style="font-size: 15px;">BIO</a> <a href="/tags/AIO/" style="font-size: 15px;">AIO</a> <a href="/tags/JMM/" style="font-size: 15px;">JMM</a> <a href="/tags/内存模型/" style="font-size: 15px;">内存模型</a> <a href="/tags/Netty/" style="font-size: 15px;">Netty</a> <a href="/tags/Tomcat/" style="font-size: 15px;">Tomcat</a> <a href="/tags/Tools/" style="font-size: 15px;">Tools</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/09/30/Distributed-Consistency/">分布式系统数据一致性问题常见解决方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/11/kafka-block/">由一次kafka消费端消息阻塞问题分析kafka消费端线程模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/23/Distributed-Transaction/">分布式事务</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/16/java-reference/">Java的强引用，软引用，弱引用，虚引用及其使用场景</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/27/InternalResourceViewResolver-Memory-Leak/">InternalResourceViewResolver引起的内存泄漏问题排查</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/05/14/Space-Based-Architecture/">基于空间的架构实践及思考</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/23/Netty-DataPacket/">Netty源码分析 解决TCP粘包拆包问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/22/jrebel-remote-server/">IntelliJ IDEA下使用JRebel远程热部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/10/Netty-Bootstrap/">Netty源码分析 Bootstrap客户端启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/01/Netty-ServerBootstrap/">Netty源码分析 ServerBootstrap服务端启动</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.csdn.net/xx_ytm" title="我的CSDN博客" target="_blank">我的CSDN博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">佑祺's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>