<!DOCTYPE html><html lang="zh-CN"><head><meta name="google-site-verification" content="DVfrDhwMEodDoWVy6nv0PCpolWhBlGBSaO9hiU2r61E"><meta name="google-site-verification" content="40TgWkMJTOetJQqAMZwk5nD5rtVQRjk5i2pe6FGka5g"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Liu Xin's Blog"><title>ThreadLocal 源码分析 | Liu Xin's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-91282031-1','auto');ga('send','pageview');</script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">ThreadLocal 源码分析</h1><a id="logo" href="/.">Liu Xin's Blog</a><p class="description">Whatever you do, you have to keep moving forward!</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">ThreadLocal 源码分析</h1><div class="post-meta">Nov 18, 2016<span> | </span><span class="category"><a href="/categories/Java/">Java</a></span></div><a data-disqus-identifier="2016/11/18/ThreadLocal-源码分析/" href="/2016/11/18/ThreadLocal-源码分析/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>ThreadLocal线程局部变量，使得各线程能够保持各自独立的一份对象。通常被定义为类的静态类变量。</p>
<p>ThreadLocal类本身定义了有get(), set(), remove()和initialValue()方法。前面三个方法是public的，initialValue()是protected的，主要用于我们在定义ThreadLocal对象的时候根据需要来重写。这样我们初始化这么一个对象在里面设置它的初始值时就用到这个方法。ThreadLocal变量因为本身定位为要被多个线程来访问，它通常被定义为static变量。</p>
<a id="more"></a>
<h1 id="ThreadLocal-API"><a href="#ThreadLocal-API" class="headerlink" title="ThreadLocal API"></a>ThreadLocal API</h1><h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p> T    get()<br>          返回此线程局部变量的当前线程副本中的值。</p>
<p> protected  T    initialValue()<br>          返回此线程局部变量的当前线程的“初始值”。</p>
<p> void    remove()<br>          移除此线程局部变量当前线程的值。</p>
<p> void    set(T value)<br>          将此线程局部变量的当前线程副本中的值设置为指定值。</p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>ThreadLocal有一个ThreadLocalMap静态内部类，ThreadLocalMap的实例是java.lang.Thread的成员变量，每个线程有唯一的一个threadLocalMap。这个map以ThreadLocal对象为key，实际存储内容为值。对ThreadLocal的操作，实际委托给当前Thread，每个Thread都会有自己独立的ThreadLocalMap实例。ThreadLocalMap使用线性探测法解决hash冲突。</p>
<h2 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h2><h3 id="T-get"><a href="#T-get" class="headerlink" title="T    get()"></a>T    get()</h3><p>返回此线程局部变量的当前线程副本中的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">public T get() &#123;</div><div class="line">    Thread t = Thread.currentThread();</div><div class="line">    ThreadLocalMap map = getMap(t);//活动当前Thread中的ThreadLocalMap</div><div class="line">    if (map != null) &#123;//不为空则从ThreadLocalMap中get当前ThreadLocal对应的value</div><div class="line">        ThreadLocalMap.Entry e = map.getEntry(this);</div><div class="line">        if (e != null)</div><div class="line">            return (T)e.value;</div><div class="line">    &#125;</div><div class="line">    //为空或者get不到，则调用setInitialValue初始化</div><div class="line">    return setInitialValue();</div><div class="line">&#125;</div><div class="line"></div><div class="line">private T setInitialValue() &#123;</div><div class="line">    T value = initialValue();//初始化方法</div><div class="line">    Thread t = Thread.currentThread();</div><div class="line">    ThreadLocalMap map = getMap(t);//获取当前Thread中的ThreadLocalMap</div><div class="line">    if (map != null)//不为空则set</div><div class="line">        map.set(this, value);</div><div class="line">    else//为空则初始化并set</div><div class="line">        createMap(t, value);</div><div class="line">    return value;//返回初始化的值</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="protected-T-initialValue"><a href="#protected-T-initialValue" class="headerlink" title="protected  T    initialValue()"></a>protected  T    initialValue()</h3><p>返回此线程局部变量的当前线程的“初始值”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">protected T initialValue() &#123;//初始化方法，由子类实现</div><div class="line">    return null;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="void-remove"><a href="#void-remove" class="headerlink" title="void    remove()"></a>void    remove()</h3><p>移除此线程局部变量当前线程的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public void remove() &#123;//获取当前线程中的ThreadLocalMap，并从中remove掉当前ThreadLocal实例对应的value</div><div class="line">    ThreadLocalMap m = getMap(Thread.currentThread());</div><div class="line">    if (m != null)</div><div class="line">        m.remove(this);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="void-set-T-value"><a href="#void-set-T-value" class="headerlink" title="void    set(T value)"></a>void    set(T value)</h3><p>将此线程局部变量的当前线程副本中的值设置为指定值。     </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public void set(T value) &#123;</div><div class="line">    Thread t = Thread.currentThread();</div><div class="line">    ThreadLocalMap map = getMap(t);//获取当前线程中的ThreadLocalMap，存在则直接set，不存在则初始化并set</div><div class="line">    if (map != null)</div><div class="line">        map.set(this, value);</div><div class="line">    else</div><div class="line">        createMap(t, value);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ThreadLocalMap getMap(Thread t) &#123;//ThreadLocalMap是Thread实例的变量</div><div class="line">       return t.threadLocals;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   void createMap(Thread t, T firstValue) &#123;//创建并set</div><div class="line">       t.threadLocals = new ThreadLocalMap(this, firstValue);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h2 id="ThreadLocalMap"><a href="#ThreadLocalMap" class="headerlink" title="ThreadLocalMap"></a>ThreadLocalMap</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div></pre></td><td class="code"><pre><div class="line">static class ThreadLocalMap &#123;</div><div class="line"></div><div class="line">    static class Entry extends WeakReference&lt;ThreadLocal&gt; &#123;//ThreadLocalMap每个单元Entry，是WeakReference类型，当ThreadLocal没有强引用，则GC时会被回收，防止内存泄漏</div><div class="line">        Object value;</div><div class="line"></div><div class="line">        Entry(ThreadLocal k, Object v) &#123;</div><div class="line">            super(k);</div><div class="line">            value = v;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static final int INITIAL_CAPACITY = 16;//初始大小</div><div class="line"></div><div class="line">    private Entry[] table;//map的节点数组</div><div class="line"></div><div class="line">    private int size = 0;//ThreadLocalMap中有多少key</div><div class="line"></div><div class="line">    private int threshold; //扩容阈值，超出则扩大table</div><div class="line"></div><div class="line">    private void setThreshold(int len) &#123;//扩容方式一般是超出当前table长度的三分之二则扩容</div><div class="line">        threshold = len * 2 / 3;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static int nextIndex(int i, int len) &#123;//线性探测法法，自增方式hash后定位的位置＋1</div><div class="line">        return ((i + 1 &lt; len) ? i + 1 : 0);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private static int prevIndex(int i, int len) &#123;//前一位置</div><div class="line">        return ((i - 1 &gt;= 0) ? i - 1 : len - 1);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    ThreadLocalMap(ThreadLocal firstKey, Object firstValue) &#123;//初始化table长度为INITIAL_CAPACITY，通过ThreadLocal的threadLocalHashCode&amp;长度－1得到当前ThreadLocal的桶的位置。</div><div class="line">        table = new Entry[INITIAL_CAPACITY];</div><div class="line">        int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1);</div><div class="line">        table[i] = new Entry(firstKey, firstValue);</div><div class="line">        size = 1;</div><div class="line">        setThreshold(INITIAL_CAPACITY);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private ThreadLocalMap(ThreadLocalMap parentMap) &#123;//复制ThreadLocalMap，一般用于InheritableThreadLocal初始化</div><div class="line">        Entry[] parentTable = parentMap.table;</div><div class="line">        int len = parentTable.length;</div><div class="line">        setThreshold(len);</div><div class="line">        table = new Entry[len];</div><div class="line"></div><div class="line">        for (int j = 0; j &lt; len; j++) &#123;</div><div class="line">            Entry e = parentTable[j];</div><div class="line">            if (e != null) &#123;</div><div class="line">                ThreadLocal key = e.get();</div><div class="line">                if (key != null) &#123;</div><div class="line">                    Object value = key.childValue(e.value);</div><div class="line">                    Entry c = new Entry(key, value);</div><div class="line">                    int h = key.threadLocalHashCode &amp; (len - 1);</div><div class="line">                    while (table[h] != null)</div><div class="line">                        h = nextIndex(h, len);</div><div class="line">                    table[h] = c;</div><div class="line">                    size++;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private Entry getEntry(ThreadLocal key) &#123;//获取ThreadLocal对应value</div><div class="line">        int i = key.threadLocalHashCode &amp; (table.length - 1);//定位算法</div><div class="line">        Entry e = table[i];</div><div class="line">        if (e != null &amp;&amp; e.get() == key)</div><div class="line">            return e;//获取到则直接返回</div><div class="line">        else</div><div class="line">            return getEntryAfterMiss(key, i, e);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void set(ThreadLocal key, Object value) &#123;//定位ThreadLocal的下标，然后set，冲突则用线性探测法，找到一个可用下标，超出一定的key数量则rehash</div><div class="line"></div><div class="line">        Entry[] tab = table;</div><div class="line">        int len = tab.length;</div><div class="line">        int i = key.threadLocalHashCode &amp; (len-1);</div><div class="line"></div><div class="line">        for (Entry e = tab[i];</div><div class="line">             e != null;</div><div class="line">             e = tab[i = nextIndex(i, len)]) &#123;</div><div class="line">            ThreadLocal k = e.get();</div><div class="line"></div><div class="line">            if (k == key) &#123;</div><div class="line">                e.value = value;</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (k == null) &#123;</div><div class="line">                replaceStaleEntry(key, value, i);</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        tab[i] = new Entry(key, value);</div><div class="line">        int sz = ++size;</div><div class="line">        if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</div><div class="line">            rehash();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void remove(ThreadLocal key) &#123;//移除ThreadLocal对应的value</div><div class="line">        Entry[] tab = table;</div><div class="line">        int len = tab.length;</div><div class="line">        int i = key.threadLocalHashCode &amp; (len-1);</div><div class="line">        for (Entry e = tab[i];</div><div class="line">             e != null;</div><div class="line">             e = tab[i = nextIndex(i, len)]) &#123;</div><div class="line">            if (e.get() == key) &#123;</div><div class="line">                e.clear();</div><div class="line">                expungeStaleEntry(i);</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void rehash() &#123;</div><div class="line">        expungeStaleEntries();</div><div class="line">        if (size &gt;= threshold - threshold / 4)//key数量超出3/4则resize</div><div class="line">            resize();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    private void resize() &#123;//创建两倍于原来的table，并重新set所有Key</div><div class="line">        Entry[] oldTab = table;</div><div class="line">        int oldLen = oldTab.length;</div><div class="line">        int newLen = oldLen * 2;</div><div class="line">        Entry[] newTab = new Entry[newLen];</div><div class="line">        int count = 0;</div><div class="line"></div><div class="line">        for (int j = 0; j &lt; oldLen; ++j) &#123;</div><div class="line">            Entry e = oldTab[j];</div><div class="line">            if (e != null) &#123;</div><div class="line">                ThreadLocal k = e.get();</div><div class="line">                if (k == null) &#123;</div><div class="line">                    e.value = null; // Help the GC</div><div class="line">                &#125; else &#123;</div><div class="line">                    int h = k.threadLocalHashCode &amp; (newLen - 1);</div><div class="line">                    while (newTab[h] != null)</div><div class="line">                        h = nextIndex(h, newLen);</div><div class="line">                    newTab[h] = e;</div><div class="line">                    count++;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        setThreshold(newLen);</div><div class="line">        size = count;</div><div class="line">        table = newTab;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="ThreadLocalMap的定位方法："><a href="#ThreadLocalMap的定位方法：" class="headerlink" title="ThreadLocalMap的定位方法："></a>ThreadLocalMap的定位方法：</h2><p><strong>int index = threadLocalHashCode &amp; (len - 1)</strong></p>
<p>HASH_INCREMENT = 0x61c88647</p>
<p>每个ThreadLocal中的threadLocalHashCode都是HASH_INCREMENT的倍数，0x61c88647这个数字&amp;上2的n次方-1的数字，hash分布十分的均匀。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public class ThreadLocal&lt;T&gt; &#123;</div><div class="line"></div><div class="line">    private final int threadLocalHashCode = nextHashCode();</div><div class="line"></div><div class="line">    private static AtomicInteger nextHashCode =</div><div class="line">        new AtomicInteger();</div><div class="line"></div><div class="line">    private static final int HASH_INCREMENT = 0x61c88647;</div><div class="line"></div><div class="line">    private static int nextHashCode() &#123;</div><div class="line">        return nextHashCode.getAndAdd(HASH_INCREMENT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	... ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="测试hash分布"><a href="#测试hash分布" class="headerlink" title="测试hash分布"></a>测试hash分布</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public class ThreadLocalTest &#123;</div><div class="line"></div><div class="line">    public static void main(String[] args) &#123;</div><div class="line">        int HASH_INCREMENT = 0x61c88647;</div><div class="line">        AtomicInteger atomicInteger = new AtomicInteger();</div><div class="line">        for (int i = 0; i &lt; 32; i++) &#123;</div><div class="line">            int hash = atomicInteger.getAndAdd(HASH_INCREMENT);</div><div class="line">            System.out.println(hash &amp; 31);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出：<br>0<br>7<br>14<br>21<br>28<br>3<br>10<br>17<br>24<br>31<br>6<br>13<br>20<br>27<br>2<br>9<br>16<br>23<br>30<br>5<br>12<br>19<br>26<br>1<br>8<br>15<br>22<br>29<br>4<br>11<br>18<br>25<br>可以看到几乎没有发生hash冲突。</p>
<h1 id="ThreadLocal使用方式"><a href="#ThreadLocal使用方式" class="headerlink" title="ThreadLocal使用方式"></a>ThreadLocal使用方式</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">public class ThreadLocalTest &#123;</div><div class="line"></div><div class="line">    private static class Count &#123;</div><div class="line">        private int count;</div><div class="line"></div><div class="line">        public int getCount() &#123;</div><div class="line">            return count;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        public void setCount(int count) &#123;</div><div class="line">            this.count = count;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static final ThreadLocal&lt;Count&gt; threadLocal = new ThreadLocal&lt;Count&gt;() &#123;</div><div class="line">        @Override</div><div class="line">        protected Count initialValue() &#123;</div><div class="line">            return new Count();</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">｝</div></pre></td></tr></table></figure>
<h2 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h2><ol>
<li>ThreadLocal应定义为静态成员变量。</li>
<li>能通过传值传递的参数，不要通过ThreadLocal存储，以免造成ThreadLocal的滥用。</li>
<li>在线程池的情况下，在ThreadLocal业务周期处理完成时，最好显式的调用remove()方法。</li>
</ol>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://my.oschina.net/xianggao/blog/392440?fromerr=CLZtT4xC" target="_blank" rel="external">深入JDK源码之ThreadLocal类</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://blogxin.cn/2016/11/18/ThreadLocal-源码分析/" data-id="cj8hictr3001wi76z3elnrqf8" class="article-share-link">分享</a><div class="tags"><a href="/tags/Java/">Java</a><a href="/tags/源码/">源码</a></div><div class="post-nav"><a href="/2016/11/27/JUC-ThreadPoolExecutor/" class="pre">JUC - ThreadPoolExecutor 源码分析</a><a href="/2016/11/17/Unsafe-源码分析/" class="next">【转】Unsafe 源码分析</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论 「请确保 disqus.com 可以正常加载」</button></div><script>var disqus_shortname = 'kris-liu';
var disqus_identifier = '2016/11/18/ThreadLocal-源码分析/';
var disqus_title = 'ThreadLocal 源码分析';
var disqus_url = 'http://blogxin.cn/2016/11/18/ThreadLocal-源码分析/';
$('.btn_click_load').click(function() {
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  $('.btn_click_load').css('display','none');
});
$.ajax({
  url: 'https://disqus.com/favicon.ico',
  timeout: 3000,
  type: 'GET',
  success: (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    $('.btn_click_load').css('display','none');
  })(),
  error: function() {
    $('.btn_click_load').css('display','block');
  }
});</script><script id="dsq-count-scr" src="//kris-liu.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://blogxin.cn"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Concurrent/">Concurrent</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/IO-NIO/">IO&NIO</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/线上问题/">线上问题</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/异步/" style="font-size: 15px;">异步</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/线上问题/" style="font-size: 15px;">线上问题</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/内存泄漏/" style="font-size: 15px;">内存泄漏</a> <a href="/tags/IO/" style="font-size: 15px;">IO</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/锁/" style="font-size: 15px;">锁</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a> <a href="/tags/GC/" style="font-size: 15px;">GC</a> <a href="/tags/读写锁/" style="font-size: 15px;">读写锁</a> <a href="/tags/缓存/" style="font-size: 15px;">缓存</a> <a href="/tags/线程池/" style="font-size: 15px;">线程池</a> <a href="/tags/BIO/" style="font-size: 15px;">BIO</a> <a href="/tags/AIO/" style="font-size: 15px;">AIO</a> <a href="/tags/Netty/" style="font-size: 15px;">Netty</a> <a href="/tags/JMM/" style="font-size: 15px;">JMM</a> <a href="/tags/内存模型/" style="font-size: 15px;">内存模型</a> <a href="/tags/Tomcat/" style="font-size: 15px;">Tomcat</a> <a href="/tags/Tools/" style="font-size: 15px;">Tools</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/06/27/InternalResourceViewResolver-Memory-Leak/">InternalResourceViewResolver引起的内存泄漏问题排查</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/22/jrebel-remote-server/">IntelliJ IDEA下使用JRebel远程热部署</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/10/Netty-Bootstrap/">Netty源码分析 Bootstrap客户端启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/04/01/Netty-ServerBootstrap/">Netty源码分析 ServerBootstrap服务端启动</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/20/Netty-epollbug/">Netty源码分析 解决NIO的epoll死循环bug</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/18/Netty-NioEventLoop/">Netty源码分析 I/O线程NioEventLoop</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/11/Netty-ThreadModel/">Netty 线程模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/31/mappedbytebuffer-zerocopy/">Java NIO 文件IO-内存映射文件MappedByteBuffer与zerocopy技术</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/24/Java-NIO-Selector详解/">Java NIO Selector详解</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/18/Java-NIO-Channel详解/">Java NIO Channel详解</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//kris-liu.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.csdn.net/xx_ytm" title="我的CSDN博客" target="_blank">我的CSDN博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">Liu Xin's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>