<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Kris's Blog"><title>JUC - FutureTask 源码分析 | Kris's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/5.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.1.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">JUC - FutureTask 源码分析</h1><a id="logo" href="/.">Kris's Blog</a><p class="description">Whatever you do, you have to keep moving forward!</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">JUC - FutureTask 源码分析</h1><div class="post-meta">Nov 29, 2016<span> | </span><span class="category"><a href="/categories/Concurrent/">Concurrent</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-thread-key="2016/11/29/JUC-FutureTask-源码分析/" href="/2016/11/29/JUC-FutureTask-源码分析/#comments" class="ds-thread-count"></a><div class="post-content"><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>FutureTask，可取消的异步计算。利用开始和取消计算的方法、查询计算是否完成的方法和获取计算结果的方法，此类提供了对 Future 的基本实现。仅在计算完成时才能获取结果；如果计算尚未完成，则阻塞 get 方法。一旦计算完成，就不能再重新开始或取消计算。可使用 FutureTask 包装 Callable 或 Runnable 对象。因为 FutureTask 实现了 Runnable，所以可将 FutureTask 提交给 Executor 执行。</p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><h2 id="FutureTask类继承关系"><a href="#FutureTask类继承关系" class="headerlink" title="FutureTask类继承关系"></a>FutureTask类继承关系</h2><p>FutureTask类实现了RunnableFuture接口，RunnableFuture接口继承自Future接口和Runnable接口，整合了一下Future接口和Runnable接口。<br>其中的方法在FutureTask中做了具体的实现。</p>
<ul>
<li>Future接口表示异步计算的结果。它提供了检查计算是否完成的方法，以等待计算的完成，并获取计算的结果。计算完成后只能使用 get 方法来获取结果，如有必要，计算完成前可以阻塞此方法。取消则由 cancel 方法来执行。还提供了其他方法，以确定任务是正常完成还是被取消了。一旦计算完成，就不能再取消计算。</li>
<li>Runnable接口是为了方便把FutureTask提交给线程池，线程池中的工作线程将调用他的 run 方法。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//试图取消对此任务的执行</span></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span></span>;</div><div class="line"></div><div class="line">	<span class="comment">//如果在任务正常完成前将其取消，则返回 true。</span></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCancelled</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="comment">//如果任务已完成，则返回 true。</span></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="comment">//如有必要，等待计算完成，然后获取其结果。</span></div><div class="line">    <span class="function">V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException</span>;</div><div class="line"></div><div class="line">	<span class="comment">//如有必要，最多等待为使计算完成所给定的时间之后，获取其结果（如果结果可用）。</span></div><div class="line">    <span class="function">V <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException</span>;</div><div class="line">        </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">Runnable</span> &#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span>(<span class="params"></span>)</span>;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="FutureTask核心属性"><a href="#FutureTask核心属性" class="headerlink" title="FutureTask核心属性"></a>FutureTask核心属性</h2><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">  <span class="comment">/**</span></div><div class="line">   * 状态扭转</div><div class="line">   * NEW -&gt; COMPLETING -&gt; NORMAL //正常完成 </div><div class="line">   * NEW -&gt; COMPLETING -&gt; EXCEPTIONAL //异常 </div><div class="line">   * NEW -&gt; CANCELLED //取消 </div><div class="line">   * NEW -&gt; INTERRUPTING -&gt; INTERRUPTED //中断</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> state;<span class="comment">//Future状态</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="keyword">NEW</span>          = <span class="number">0</span>;<span class="comment">//初始化</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> COMPLETING   = <span class="number">1</span>;<span class="comment">//运行中</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NORMAL       = <span class="number">2</span>;<span class="comment">//正常完成</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXCEPTIONAL  = <span class="number">3</span>;<span class="comment">//异常</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED    = <span class="number">4</span>;<span class="comment">//已取消</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INTERRUPTING = <span class="number">5</span>;<span class="comment">//中断中</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INTERRUPTED  = <span class="number">6</span>;<span class="comment">//中断完成</span></div><div class="line"></div><div class="line">  <span class="comment">//内部的callable，运行完成后设置为null</span></div><div class="line">  <span class="keyword">private</span> Callable&lt;V&gt; callable;</div><div class="line">  </div><div class="line">  <span class="comment">//从get方法返回或者抛出异常</span></div><div class="line">  <span class="keyword">private</span> Object outcome; <span class="comment">//没有volatile修饰, 通过状态字段state读写保证了可见性</span></div><div class="line">  </div><div class="line">  <span class="comment">//执行内部callable的线程</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> Thread runner;</div><div class="line">  </div><div class="line">  <span class="comment">/** </span></div><div class="line">* Treiber stack 等待线程的非阻塞堆栈，存放所有等待的线程</div><div class="line">   * 首先获取当前最顶的节点，创建一个新节点放在堆栈上，</div><div class="line">   * 如果最顶端的节点在获取之后没有变化，那么就设置上新节点。</div><div class="line">   * 如果 CAS 失败，意味着另一个线程已经修改了堆栈，</div><div class="line">   * 那么会重新执行上述操作。</div><div class="line">   */</div><div class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> WaitNode waiters;</div><div class="line"></div><div class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> WaitNode &#123;<span class="comment">//包含了当前线程对象，并有指向下一个WaitNode的指针next，Treiber Stack就是由WaitNode组成的一个单向链表。</span></div><div class="line">      <span class="keyword">volatile</span> Thread thread;</div><div class="line">      <span class="keyword">volatile</span> WaitNode <span class="keyword">next</span>;</div><div class="line">      WaitNode() &#123; thread = Thread.currentThread(); &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h2 id="FutureTask核心方法源码分析"><a href="#FutureTask核心方法源码分析" class="headerlink" title="FutureTask核心方法源码分析"></a>FutureTask核心方法源码分析</h2><h3 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> FutureTask(Callable&lt;V&gt; callable) &#123;</div><div class="line">       <span class="keyword">if</span> (callable == <span class="literal">null</span>)</div><div class="line">           <span class="keyword">throw</span> new NullPointerException();</div><div class="line">       <span class="keyword">this</span>.callable = callable;</div><div class="line">       <span class="keyword">this</span>.state = NEW;<span class="comment">//volatile写保证callable的可见性</span></div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="keyword">public</span> FutureTask(Runnable runnable, V result) &#123;</div><div class="line">       <span class="keyword">this</span>.callable = Executors.callable(runnable, result);<span class="comment">//包装成一个Callable</span></div><div class="line">       <span class="keyword">this</span>.state = NEW;<span class="comment">//volatile写保证callable的</span></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">   <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Callable&lt;T&gt; callable(Runnable <span class="keyword">task</span>, T result) &#123;</div><div class="line">       <span class="keyword">if</span> (<span class="keyword">task</span> == <span class="keyword">null</span>)</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">       <span class="keyword">return</span> <span class="keyword">new</span> RunnableAdapter&lt;T&gt;(<span class="keyword">task</span>, result);</div><div class="line">   &#125;</div><div class="line">   </div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> RunnableAdapter&lt;T&gt; <span class="keyword">implements</span> Callable&lt;T&gt; &#123;<span class="comment">//把Runnable包装成一个Callable，在线程池中会执行FutureTask的run方法，在FutureTask的run方法中会执行Callable的call方法，在这个RunnableAdapter中会执行task的run方法。</span></div><div class="line">       <span class="keyword">final</span> Runnable <span class="keyword">task</span>;</div><div class="line">       <span class="keyword">final</span> T result;</div><div class="line">       RunnableAdapter(Runnable <span class="keyword">task</span>, T result) &#123;</div><div class="line">           <span class="keyword">this</span>.<span class="keyword">task</span> = <span class="keyword">task</span>;</div><div class="line">           <span class="keyword">this</span>.result = result;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">public</span> T <span class="keyword">call</span>() &#123;</div><div class="line">           <span class="keyword">task</span>.run();</div><div class="line">           <span class="keyword">return</span> result;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="核心运行方法run"><a href="#核心运行方法run" class="headerlink" title="核心运行方法run()"></a>核心运行方法run()</h3><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> run() &#123;</div><div class="line">    <span class="keyword">if</span> (state != <span class="keyword">NEW</span> ||</div><div class="line">        !UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, runnerOffset, <span class="keyword">null</span>, Thread.currentThread()))<span class="comment">//如果当前状态不是NEW，或者状态是NEW但是将执行线程runner用CAS从null更新为当前线程失败，则直接退出</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Callable&lt;V&gt; c = callable;<span class="comment">//获取当前需要执行的callable</span></div><div class="line">        <span class="keyword">if</span> (c != <span class="keyword">null</span> &amp;&amp; state == <span class="keyword">NEW</span>) &#123;<span class="comment">//callable不为null且状态是NEW，则执行业务逻辑</span></div><div class="line">            V result;<span class="comment">//call方法的返回值</span></div><div class="line">            <span class="keyword">boolean</span> ran;<span class="comment">//是否正常执行完成</span></div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                result = c.<span class="keyword">call</span>();<span class="comment">//调用call方法</span></div><div class="line">                ran = <span class="keyword">true</span>;<span class="comment">//是正常完成设置true</span></div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;<span class="comment">//如果抛出异常</span></div><div class="line">                result = <span class="keyword">null</span>;<span class="comment">//设置结果为null</span></div><div class="line">                ran = <span class="keyword">false</span>;<span class="comment">//设置非正常完成false</span></div><div class="line">                setException(ex);<span class="comment">//设置异常</span></div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (ran)<span class="comment">//正常完成</span></div><div class="line">                set(result);<span class="comment">//设置返回结果</span></div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        runner = <span class="keyword">null</span>;<span class="comment">//将执行线程设置为null</span></div><div class="line">        <span class="keyword">int</span> s = state;<span class="comment">//重新读取状态</span></div><div class="line">        <span class="keyword">if</span> (s &gt;= INTERRUPTING)<span class="comment">//如果是中断的，处理中断</span></div><div class="line">            handlePossibleCancellationInterrupt(s);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="keyword">void</span> set(V v) &#123;<span class="comment">//设置结果</span></div><div class="line">    <span class="keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="keyword">this</span>, stateOffset, <span class="keyword">NEW</span>, COMPLETING)) &#123;<span class="comment">//首先将状态从NEW更改为COMPLETING</span></div><div class="line">        outcome = v;<span class="comment">//将结果负值给outcome</span></div><div class="line">        UNSAFE.putOrderedInt(<span class="keyword">this</span>, stateOffset, NORMAL); <span class="comment">//设置结果为NORMAL，正常完成</span></div><div class="line">        finishCompletion();<span class="comment">//唤醒Treiber stack所有等待线程</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="keyword">void</span> setException(Throwable t) &#123;</div><div class="line">    <span class="keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="keyword">this</span>, stateOffset, <span class="keyword">NEW</span>, COMPLETING)) &#123;<span class="comment">////首先将状态从NEW更改为COMPLETING</span></div><div class="line">        outcome = t;<span class="comment">//设置结果为异常t</span></div><div class="line">        UNSAFE.putOrderedInt(<span class="keyword">this</span>, stateOffset, EXCEPTIONAL); <span class="comment">//设置结果为EXCEPTIONAL，运行异常</span></div><div class="line">        finishCompletion();<span class="comment">//唤醒Treiber stack所有等待线程</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> finishCompletion() &#123;<span class="comment">//唤醒所有等待线程</span></div><div class="line">    <span class="comment">// assert state &gt; COMPLETING;</span></div><div class="line">    <span class="keyword">for</span> (WaitNode q; (q = waiters) != <span class="keyword">null</span>;) &#123;<span class="comment">//如果有等待线程，设置为q</span></div><div class="line">        <span class="keyword">if</span> (UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, waitersOffset, q, <span class="keyword">null</span>)) &#123;<span class="comment">//将waiters用CAS从q设置为null，置空所有等待线程</span></div><div class="line">            <span class="keyword">for</span> (;;) &#123;<span class="comment">//从q开始遍历WaitNode栈，唤醒所有的等待线程</span></div><div class="line">                Thread t = q.thread;</div><div class="line">                <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</div><div class="line">                    q.thread = <span class="keyword">null</span>;</div><div class="line">                    LockSupport.unpark(t);</div><div class="line">                &#125;</div><div class="line">                WaitNode <span class="keyword">next</span> = q.<span class="keyword">next</span>;</div><div class="line">                <span class="keyword">if</span> (<span class="keyword">next</span> == <span class="keyword">null</span>)</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                q.<span class="keyword">next</span> = <span class="keyword">null</span>; <span class="comment">// unlink to help gc</span></div><div class="line">                q = <span class="keyword">next</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    done();<span class="comment">//执行扩展点done方法</span></div><div class="line"></div><div class="line">    callable = <span class="keyword">null</span>; <span class="comment">//将需要执行的callable设置为null</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">void</span> handlePossibleCancellationInterrupt(<span class="keyword">int</span> s) &#123;</div><div class="line">    <span class="keyword">if</span> (s == INTERRUPTING)<span class="comment">//如果状态是INTERRUPTING，则让出cpu等待状态变成INTERRUPTED才结束</span></div><div class="line">        <span class="keyword">while</span> (state == INTERRUPTING)</div><div class="line">            Thread.yield(); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="V-get-throws-InterruptedException-ExecutionException"><a href="#V-get-throws-InterruptedException-ExecutionException" class="headerlink" title="V get() throws InterruptedException, ExecutionException"></a>V get() throws InterruptedException, ExecutionException</h3><p>等待计算完成，然后获取其结果。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function">V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</div><div class="line">    <span class="keyword">int</span> s = state;</div><div class="line">    <span class="keyword">if</span> (s &lt;= COMPLETING)<span class="comment">//如果是初始化或者运行中状态，则调用awaitDone等待执行完成后唤醒返回。</span></div><div class="line">        s = awaitDone(<span class="keyword">false</span>, <span class="number">0</span>L);<span class="comment">//返回结果是当前Future状态</span></div><div class="line">    <span class="function"><span class="keyword">return</span> <span class="title">report</span><span class="params">(s)</span></span>;<span class="comment">//返回结果</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">int</span> <span class="title">awaitDone</span><span class="params">(<span class="keyword">boolean</span> timed, <span class="keyword">long</span> nanos)</span></span></div><div class="line">    <span class="keyword">throws</span> InterruptedException &#123;<span class="comment">//timed标示是否超时等待，nano代表超时等待时间</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">long</span> deadline = timed ? System.nanoTime() + nanos : 0L;<span class="comment">//获取最长的等待时间，支持超时是当前时间加上等待时间得到未来需要等到的最长时间点，不支持超时是0。</span></div><div class="line">    WaitNode q = <span class="keyword">null</span>;<span class="comment">//当前线程节点</span></div><div class="line">    <span class="keyword">boolean</span> queued = <span class="keyword">false</span>;<span class="comment">//当前q节点是否加入等待线程栈中</span></div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;<span class="comment">//如果当前线程被中断，移除当前等待节点q，然后抛出中断异常</span></div><div class="line">            removeWaiter(q);<span class="comment">//从等待线程中移除当前节点q</span></div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> s = state;</div><div class="line">        <span class="keyword">if</span> (s &gt; COMPLETING) &#123;<span class="comment">//如果已经完成则置空当前节点，并返回完成状态</span></div><div class="line">            <span class="keyword">if</span> (q != <span class="keyword">null</span>)</div><div class="line">                q.thread = <span class="keyword">null</span>;</div><div class="line">            <span class="keyword">return</span> s;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s == COMPLETING) <span class="comment">//如果是COMPLETING，则意味着业务逻辑已经执行结束，让出cpu等待最终状态更新完成后返回</span></div><div class="line">            Thread.yield();</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (q == <span class="keyword">null</span>)<span class="comment">//q==null时，初始化当前线程节点q</span></div><div class="line">            q = <span class="keyword">new</span> WaitNode();</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!queued)<span class="comment">//如果当前节点q不再等待线程栈中，则CAS将当前节点加入等待线程栈中，放在等待线程栈的顶部</span></div><div class="line">            queued = UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, waitersOffset, q.next = waiters, q);</div><div class="line">        <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(timed)</span> </span>&#123;<span class="comment">//如果支持超时等待，则挂起线程直到超时</span></div><div class="line">            nanos = deadline - System.nanoTime();</div><div class="line">            <span class="keyword">if</span> (nanos &lt;= <span class="number">0</span>L) &#123;<span class="comment">//如果已经超时，则从等待线程栈中移除当前节点q，并返回当前状态。</span></div><div class="line">                removeWaiter(q);</div><div class="line">                <span class="keyword">return</span> state;</div><div class="line">            &#125;</div><div class="line">            LockSupport.parkNanos(<span class="keyword">this</span>, nanos);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span><span class="comment">//如果不支持超时等待，则直接挂起线程</span></div><div class="line">            LockSupport.park(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">void</span> <span class="title">removeWaiter</span><span class="params">(WaitNode node)</span> </span>&#123;<span class="comment">//移除当前等待节点node</span></div><div class="line">    <span class="keyword">if</span> (node != <span class="keyword">null</span>) &#123;</div><div class="line">        node.thread = <span class="keyword">null</span>;<span class="comment">//下面会将node从等待队列中移除，以thread字段为null为依据，出现竞争则重试</span></div><div class="line">        retry:</div><div class="line">        <span class="keyword">for</span> (;;) &#123;          <span class="comment">// restart on removeWaiter race</span></div><div class="line">            <span class="keyword">for</span> (WaitNode pred = <span class="keyword">null</span>, q = waiters, s; q != <span class="keyword">null</span>; q = s) &#123;</div><div class="line">                s = q.next;</div><div class="line">                <span class="keyword">if</span> (q.thread != <span class="keyword">null</span>)</div><div class="line">                    pred = q;</div><div class="line">                <span class="function"><span class="keyword">else</span> <span class="title">if</span> <span class="params">(pred != <span class="keyword">null</span>)</span> </span>&#123;</div><div class="line">                    pred.next = s;</div><div class="line">                    <span class="keyword">if</span> (pred.thread == <span class="keyword">null</span>) <span class="comment">// check for race</span></div><div class="line">                        <span class="keyword">continue</span> retry;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (!UNSAFE.compareAndSwapObject(<span class="keyword">this</span>, waitersOffset,</div><div class="line">                                                      q, s))</div><div class="line">                    <span class="keyword">continue</span> retry;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="function">V <span class="title">report</span><span class="params">(<span class="keyword">int</span> s)</span> <span class="keyword">throws</span> ExecutionException </span>&#123;</div><div class="line">    Object x = outcome;</div><div class="line">    <span class="keyword">if</span> (s == NORMAL)<span class="comment">//状态是正常完成，则直接返回outcome</span></div><div class="line">        <span class="keyword">return</span> (V)x;</div><div class="line">    <span class="keyword">if</span> (s &gt;= CANCELLED)<span class="comment">//如果是取消后的状态，则直接返回CancellationException，中断也是属于取消的状态</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CancellationException();</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException((Throwable)x);<span class="comment">//其他状态都返回ExecutionException</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="V-get-long-timeout-TimeUnit-unit-throws-InterruptedException-ExecutionException-TimeoutException"><a href="#V-get-long-timeout-TimeUnit-unit-throws-InterruptedException-ExecutionException-TimeoutException" class="headerlink" title="V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException"></a>V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException</h3><p>最多等待为使计算完成所给定的时间之后，获取其结果（如果结果可用）。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function">V <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></div><div class="line">    <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException &#123;</div><div class="line">    <span class="keyword">if</span> (unit == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    <span class="keyword">int</span> s = state;</div><div class="line">    <span class="keyword">if</span> (s &lt;= COMPLETING &amp;&amp;</div><div class="line">        (s = awaitDone(<span class="keyword">true</span>, unit.toNanos(timeout))) &lt;= COMPLETING)<span class="comment">//超时等待，如果从awaitDone返回时，状态还是NEW或者COMPLETING，则意味着超时，抛出超时异常</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</div><div class="line">    <span class="function"><span class="keyword">return</span> <span class="title">report</span><span class="params">(s)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="boolean-cancel-boolean-mayInterruptIfRunning"><a href="#boolean-cancel-boolean-mayInterruptIfRunning" class="headerlink" title="boolean cancel(boolean mayInterruptIfRunning)"></a>boolean cancel(boolean mayInterruptIfRunning)</h3><p>试图取消对此任务的执行。如果任务已完成、或已取消，或者由于某些其他原因而无法取消，则此尝试将失败。当调用 cancel 时，如果调用成功，而此任务尚未启动，则此任务将永不运行。如果任务已经启动，则 mayInterruptIfRunning 参数确定是否应该以试图停止任务的方式来中断执行此任务的线程。如果此时业务方法在执行中且FutureTask状态还是NEW时，可以取消FutureTask，但是无法停止业务方法的执行，取消之后，即使业务方法执行完毕也无法获取执行结果，因为FutureTask状态是取消的。</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public boolean cancel(boolean mayInterruptIfRunning) &#123;</div><div class="line">    if (<span class="keyword">state</span> != NEW)//如果是NEW状态，则一定没取消返回false</div><div class="line">        return false;</div><div class="line">    if (mayInterruptIfRunning) &#123;//如果强制取消则中断的方式取消任务</div><div class="line">        if (!UNSAFE.compareAndSwapInt(this, <span class="keyword">state</span>Offset, NEW, INTERRUPTING))//用CAS将<span class="keyword">state</span>从NEW更新到INTERRUPTING，失败则返回false取消失败，成功则中断运行任务的线程，然后将状态设置为INTERRUPTED，然后唤醒所有等待线程返回true取消成功</div><div class="line">            return false;</div><div class="line">        Thread t = runner;</div><div class="line">        if (t != null)</div><div class="line">            t.interrupt();//中断运行线程（如果在线程池中执行任务，该中断会中断线程池中的工作线程，线程池中工作线程的run方法中会清除线程的中断状态）</div><div class="line">        UNSAFE.putOrderedInt(this, <span class="keyword">state</span>Offset, INTERRUPTED); // final <span class="keyword">state</span></div><div class="line">    &#125;</div><div class="line">    else if (!UNSAFE.compareAndSwapInt(this, <span class="keyword">state</span>Offset, NEW, CANCELLED))//如果不是强制取消，用CAS将<span class="keyword">state</span>从NEW更新到CANCELLED，失败则返回false取消失败，成功则唤醒所有等待线程返回true取消成功</div><div class="line">        return false;</div><div class="line">    finishCompletion();//唤醒所有等待线程</div><div class="line">    return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="boolean-isCancelled"><a href="#boolean-isCancelled" class="headerlink" title="boolean isCancelled()"></a>boolean isCancelled()</h3><p>如果在任务正常完成前将其取消，则返回 true。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">isCancelled</span><span class="params">()</span> </span>&#123;<span class="comment">//大于等于CANCELLED都是取消，中断也是取消</span></div><div class="line">    <span class="keyword">return</span> state &gt;= CANCELLED;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="boolean-isDone"><a href="#boolean-isDone" class="headerlink" title="boolean isDone()"></a>boolean isDone()</h3><p>如果任务已完成，则返回 true。 可能由于正常终止、异常或取消而完成，在所有这些情况中，此方法都将返回 true。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span> </span>&#123;<span class="comment">//不是NEW就代表已经执行完成任务，等待返回了</span></div><div class="line">    <span class="keyword">return</span> state != NEW;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="FutureTask扩展点"><a href="#FutureTask扩展点" class="headerlink" title="FutureTask扩展点"></a>FutureTask扩展点</h2><p>任务执行完成后执行，可自定义处理逻辑，做监控或记录等等。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">done</span><span class="params">()</span> </span>&#123; &#125;</div></pre></td></tr></table></figure></div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://kris-liu.github.io/2016/11/29/JUC-FutureTask-源码分析/" data-id="ciylu9gbo000ada6zlj8rmxpw" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Java/">Java</a><a href="/tags/并发/">并发</a><a href="/tags/源码/">源码</a><a href="/tags/异步/">异步</a></div><div class="post-nav"><a href="/2016/12/18/Java-IO模型/" class="pre">Java IO模型</a><a href="/2016/11/27/JUC-ThreadPoolExecutor-源码分析/" class="next">JUC - ThreadPoolExecutor 源码分析</a></div><div data-thread-key="2016/11/29/JUC-FutureTask-源码分析/" data-title="JUC - FutureTask 源码分析" data-url="https://kris-liu.github.io/2016/11/29/JUC-FutureTask-源码分析/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2016/11/29/JUC-FutureTask-源码分析/" data-title="JUC - FutureTask 源码分析" data-url="https://kris-liu.github.io/2016/11/29/JUC-FutureTask-源码分析/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://kris-liu.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Concurrent/">Concurrent</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/IO-NIO/">IO&NIO</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/缓存/" style="font-size: 15px;">缓存</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/NIO/" style="font-size: 15px;">NIO</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/并发/" style="font-size: 15px;">并发</a> <a href="/tags/锁/" style="font-size: 15px;">锁</a> <a href="/tags/源码/" style="font-size: 15px;">源码</a> <a href="/tags/异步/" style="font-size: 15px;">异步</a> <a href="/tags/读写锁/" style="font-size: 15px;">读写锁</a> <a href="/tags/IO/" style="font-size: 15px;">IO</a> <a href="/tags/线程池/" style="font-size: 15px;">线程池</a> <a href="/tags/BIO/" style="font-size: 15px;">BIO</a> <a href="/tags/AIO/" style="font-size: 15px;">AIO</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/JMM/" style="font-size: 15px;">JMM</a> <a href="/tags/内存模型/" style="font-size: 15px;">内存模型</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/Tomcat/" style="font-size: 15px;">Tomcat</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/12/24/I-O-多路复用之select、poll、epoll实现原理及对比总结/">I/O 多路复用之select、poll、epoll实现原理及对比总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/18/Java-IO模型/">Java IO模型</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/29/JUC-FutureTask-源码分析/">JUC - FutureTask 源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/27/JUC-ThreadPoolExecutor-源码分析/">JUC - ThreadPoolExecutor 源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/18/ThreadLocal-源码分析/">ThreadLocal 源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/17/Unsafe-源码分析/">Unsafe 源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/15/Java-Cache-Line-伪共享及解决方案/">Java Cache Line 伪共享及解决方案</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/12/Java内存模型-JMM-核心概念总结/">Java内存模型(JMM)核心概念总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/16/JUC-ReentrantReadWriteLock-源码分析/">JUC - ReentrantReadWriteLock 源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/12/JUC-Condition-源码分析/">JUC - Condition 源码分析</a></li></ul></div><div class="widget"><div class="comments-title"><i class="fa fa-comment-o"> 最近评论</i></div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.csdn.net/xx_ytm" title="我的CSDN博客" target="_blank">我的CSDN博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Kris's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>var duoshuoQuery = {short_name:'kris-liu'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>