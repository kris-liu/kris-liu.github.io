---
title: 领域驱动设计学习
date: 2021-02-13 00:00:00
categories: 架构
tags: [架构,DDD]
---

## 领域驱动设计：

### 什么是领域驱动设计(DDD)

领域驱动设计是一种软件开发方法，它围绕业务概念构建领域模型，指导我们将复杂问题进行拆分，解决大型复杂系统在落地中遇到的问题。

领域驱动设计解决的两个核心问题：

1. 业务架构如何合理的划分。

2. 系统架构与业务架构保持一致。 将业务架构与系统架构对应起来，在响应业务变化调整业务架构时，也随之变化系统架构，建立针对业务变化的高响应力的系统架构。

领域驱动设计同时提供了战略上的和战术上的建模工具来帮助我们设计高质量的软件模型。



### 什么是领域模型

领域模型是关于某个特定领域的软件模型，通常，领域模型通过对象模型来实现，这些对象同时包含了数据和行为，并且准确表达了业务含义。领域驱动设计从业务领域视角划分领域边界，构建通用语言进行高效沟通，通过业务抽象，建立领域模型，维持业务和代码的逻辑一致性。



#### 领域模型与数据模型

数据模型关注的是数据存储，所有的业务都离不开数据，都离不开对数据的CRUD；领域模型关注的是领域知识，领域模型对应的是业务实体，它更加关注业务语义的表达，而不是数据的存储和数据之间的关系。

两个模型往往被混淆在一起，因为两者都强调实体和实体关系，正确的做法应该是把领域模型、数据模型区别开来，让他们各司其职，从而更合理的设计我们的系统。



### 为什么要用DDD

1. 统一通用语言，提升日常产研**工作沟通效率**。

2. 科学合理的领域划分和边界界定，**理清系统边界和职责，指导架构设计，降低问题复杂度**。

3. 优雅的系统设计，系统能够快速响应业务变化，有利于系统架构的演进，提升系统扩展性和可维护性，**设计出准确表达业务意图的软件模型**。

4. 切实**提升个人的架构设计能力**，思考深度和广度有明显提升。



### DDD与微服务

DDD是一种架构设计方法论，微服务是一种架构风格、是技术实现，两者从本质上都是从业务视角去分离应用系统复杂度的手段，将复杂问题进行分治。

DDD方法建立的领域模型，可以清晰地划分微服务的逻辑边界和物理边界，从而搭建一个高内聚低耦合的微服务体系，所以我们一般使用DDD来作为微服务设计的指导思想。



### 战略设计和战术设计：



#### 战略设计

战略设计主要从业务视角出发，建立业务领域模型，划分领域边界，建立通用语言的限界上下文，限界上下文可以作为微服务设计的参考边界。

DDD 战略设计会建立领域模型，领域模型可以用于指导微服务的设计和拆分。事件风暴是建立领域模型的主要方法，它是一个从发散到收敛的过程。它通常采用用例分析、场景分析和用户旅程分析，尽可能全面不遗漏地分解业务领域，并梳理领域对象之间的关系，这是一个发散的过程。事件风暴过程会产生很多的实体、命令、事件等领域对象，我们将这些领域对象从不同的维度进行聚类，形成如聚合、限界上下文等边界，建立领域模型，这就是一个收敛的过程。

在战略设计中我们建立了领域模型，划定了业务领域的边界，建立了通用语言和限界上下文，确定了领域模型中各个领域对象的关系。到这儿，业务端领域模型的设计工作基本就完成了，这个过程同时也基本确定了应用端的微服务边界。



通过 DDD 战略设计可以建立领域模型，划定领域边界，解决微服务设计过程中，边界难以划定的难题

战略建模
限界上下文 上下文映射图

战略阶段的核心目的是划分问题域，确定核心领域，整理出限界上下文。

通过战略设计，我们建立了领域模型，划分了微服务边界。



DDD关注业务战略，战略设计帮我定一不同团队之间的组织关系，用于清楚的解纷不同系统和业务的关注点，保护每个业务层面的服务。指导我们如何实现面向服务的架构



将领域逐级分解为大小合适的子域，针对子域采用事件风暴，划分聚合和限界上下文，初步确定子域内的领域模型。









#### 战术设计

战术设计则从技术视角出发，侧重于领域模型的技术实现，完成软件开发和落地，包括：聚合根、实体、值对象、领域服务、应用服务和资源库等代码逻辑的设计和实现。


战术设计的重要模式是聚合

战术设计是根据领域模型进行微服务设计的过程。

战术设计是开发人员能够按照领域专家的思维模型开发软件。







限界上下文为图案对创建了一个模型边界，成员在边界内部为特定的业务领域创建解决方案，单个界限上下文中团队共享一套通用语言，不同团队各自负责一个限界上下文。使用上下文映射图在战略层面对限界上下文进行集成，在边界内部，团队成员使用战术建模工具：聚合，实体，指对象，领域服务，领域事件等 







战术建模比战略建模复杂，核心的业务子域更适合做战术设计，在团队成员有能力持续实施战术设计时

战略设计采用的方法是事件风暴

领域建模是通过对业务和问题域进行分析，建立领域模型。向上通过限界上下文指导微服务边界设计，向下通过聚合指导实体对象设计。

领域建模是一个收敛的过程，分三步：第一步找出领域实体和值对象等领域对象；第二步找出聚合根，根据实体、值对象与聚合根的依赖关系，建立聚合；第三步根据业务及语义边界等因素，定义限界上下文。





战略设计主要关注按领域定义，在限界上下文内形成统一语言，提升业务和技术的沟通效率； 战术设计主要关注领域设计在落地时与设计模型及实现模型的差异性，减小业务和技术之间的鸿沟。

战略设计侧重于高层次、宏观上去划分和集成限界上下文，而战术设计则关注更具体使用建模工具来细化上下文。





### 事件风暴：

在事件风暴中，我们会根据一些业务操作和行为找出实体（Entity）或值对象（ValueObject），进而将业务关联紧密的实体和值对象进行组合，构成聚合，再根据业务语义将多个聚合划定到同一个限界上下文（Bounded Context）中，并在限界上下文内完成领域建模。

事件风暴正是 DDD 战略设计中经常使用的一种方法，它可以快速分析和分解复杂的业务领域，完成领域建模





事件风暴

有很强业务逻辑的地方，一般就是业务关注的发生的事件

在此之后的战术建模，需要找一个具体的模块，用事件风暴的建模方法，提炼出事件、命令、角色、聚合，进而细化领域模型、服务API、时序图、类图







## 架构：

### 分层架构：

分层架构一般分为用户接口层、应用层、领域层和基础层四层，每个层都应该具有良好的内聚性，并且只依赖比自身更低的层。分层架构分两种，松散分层架构和严格分层架构，松散分层架构允许任意上层与任意下层发生耦合；严格分层架构则只能访问其下方的层，一般来说我们会使用严格分层架构。

* 用户接口层：负责向用户显示信息和解释用户命令，这一层聚集了接口适配相关的功能。	

* 应用层：应用层指应用服务，用来协调多个领域服务和领域对象完成服务编排和组合，协作完成业务操作，不处理业务逻辑。应用层也用来调用其它微服务，完成微服务间的服务编排和组合。

* 领域层：领域层实现领域模型的业务逻辑，该层包含聚合根、实体、值对象、领域服务等领域模型中的领域对象。
* 基础层：基础层为其他层提供技术基础服务，比如数据库、缓存、消息等。基础层一般会贯穿所有其他层，通过依赖反转设计原则，基础层实现所有其他层中定义的接口。

相比于传统三层架构，DDD的分层架构将业务逻辑层拆分到了应用层和领域层，应用层快速响应前端的变化，领域层实现领域模型的能力。



### 六边形架构（端口与适配器）：
六边形架构也称为端口与适配器架构，该架构的思想是将内部核心的领域逻辑与外界依赖进行隔离，对于每种外界类型，都有一个适配器与之相对应。不同客户可以通过各种方式与系统交互，只需要添加一个新的适配器将客户输入转化成能被系统API理解的参数就行，系统输出也都有对应的适配器负责完成相应的转化功能。六边形每条边代表不同类型的端口，要么处理输入，要么处理输出。

* 端口一般指：http，消息机制
* 适配器一般指：servlet，消息监听器



### CQRS

CQRS旨在解决数据显示复杂性问题，将领域模型一分为二，命令模型和查询模型分开存储。

* 如果一个方法修改了对象的状态，该方法便是一个命令。
* 如果一个方法返回了数据，该方法便是一个查询。
  





## 核心概念介绍：

主要讲解DDD的核心知识概念，从战略设计和战术设计两方面进行介绍，具体包括：领域、子域、核心域、通用域、支撑域、通用语言、限界上下文、上下文映射、实体、值对象、聚合、领域服务、应用服务等概念。



### 战略设计

* 领域
* 通用语言
* 限界上下文
* 上下文映射




#### 领域、子域、核心域、通用域、支撑域

领域的核心思想就是将问题域逐级细分，来降低业务理解和系统实现的复杂度。通过领域细分，逐步缩小微服务需要解决的问题域，构建合适的领域模型，而领域模型映射成系统就是微服务了。

DDD中一个领域被分成若干子域，根据对业务支撑程度分为核心域、支撑域或通用域，通过领域划分，区分不同子域在公司内的不同功能属性和重要性，从而公司可对不同子域采取不同的资源投入和建设策略，其关注度也会不一样。

* 核心域：整个业务系统的核心，业务成功的主要促成因素，主要关注的。
* 支撑域：专注于业务的某个方面。
* 通用域：被用于整个业务系统。



#### 通用语言

在事件风暴过程中，通过团队交流达成共识的，能够简单、清晰、准确描述业务涵义和规则的语言就是通用语言。
通用语言的价值：解决交流障碍这个问题，使领域专家和开发人员能够协同合作，从而确保业务需求的正确表达。

通用语言作用于某个限界上下文之内

项目成员通过通用语言表达软件模型



通用语言和限界上下文沟通了DDD的两大支柱，相辅相成。通用语言作用于某个限界上下文之内。




通用语言是以限界上下文为边界的。限界上下文提供了一个语义边界，来保持通用语言和领域概念的一一对应关系。



#### 限界上下文：

通过事件风暴来划分限界上下文。

领域边界就是通过限界上下文来定义的。限界上下文是微服务设计和拆分的主要依据，一个限界上下文理论上就可以设计为一个微服务。

限界上下文会让团队明确模型的职责边界是什么。同时，通用语言被限定在限界上下文中；限界上下文提供了一个语义边界，在每个限界上下文内通用语言的每个词汇必须和领域概念一一对应。




#### 上下文映射
用于表达项目之间的集成关系，通过上下文映射对限界上下文进行集成。

限界上下文之间的关系，不同团队之间的关系存在多种组织和协作模式，常见的比如：客户方供应方开发。

1. 客户方（Downstream 下游）-供应方（Upstream 上游）开发：表示上下游团队的关系，上游团队可以独立于下游团队完成开发。下游依赖上游，上游影响下游。

集成使用的技术：

1. 开放主机（OHS）：定义一种协议让其他系统通过该协议访问你的服务。
2. 发布语言（PL）：两个限界上下文之间翻译模型需要的公用语言，一般指编码方式，比如xml，json等，一般与开放主机共同使用。
3. 防腐层（ACL）：该层作为上游系统的代理向系统提供服务。客户端领域服务访问上游开放主机服务，远程服务以发布语言形式返回，防腐层将上游返回的发布语言翻译成本地上下文的领域对象，客户端领域服务service作为防腐层接口，委派给Adapter，Adapter先访问远程开放主机，然后由Adapter通过Translator将发布语言翻译成本地领域对象。



### 战术设计

* 实体

* 值对象

* 聚合

* 领域服务

* 领域事件

* 模块

* 工厂

* 资源库

* 应用服务




#### 实体:

实体一般对应业务对象，它具有业务属性和业务行为，一个实体拥有一个固定的身份标识，可以对实体进行多次修改，由于身份标识不变，他们依然是同一个实体。
实体类通常采用充血模型，与这个实体相关的所有业务逻辑都在实体类的方法中实现，跨多个实体的领域逻辑则在领域服务中实现。

唯一标识和可变性是实体和值对象的区别。



#### 值对象：

值对象用于度量和描述事物，一般用来对实体的状态和特征进行描述。一个值对象可以只处理单个属性也可以处理一组相关联的属性。

值对象不可变，只能整体替换，值对象的行为方法属于无副作用函数，不会改变内部属性。



#### 聚合：

聚合就是由业务和逻辑紧密关联的实体和值对象组合而成的，聚合对象树的根节点就是聚合根。

聚合的原则：

1. 在一致性边界内建模不变条件。不变条件表示一个业务规则，该规则总是保持一致的；一致性指事务一致性，一个事务中只能修改一个聚合。
2. 设计小聚合，可以提高伸缩性、性能、可用性。
3. 通过唯一标识引用其他聚合。
4. 聚合的边界外使用最终一致性。

聚合内的业务功能内聚，能独立完成特定业务逻辑。聚合可以作为最小基础单元，完成领域模型和微服务架构的设计和演进，一个聚合就可以作为一个微服务。



#### 领域服务：

领域中的服务表示一个无状态的操作，用于实现特定于某个领域的任务。当操作不适合放到实体和值对象上时，或者当某些功能是无法映射到具体的对象中时，最好的方式就是使用领域服务了。领域服务可以用来组合多个实体或者值对象，实现复杂的业务逻辑。当多个领域服务的组合编排在多个应用服务中被复用，也可以将其抽取成新的领域服务。



#### 领域事件：

表示领域专家关心的发生在领域中的一些事件，有很强业务逻辑的地方，一般就是业务关注的发生的事件，一个领域事件将导致进一步的业务操作。在建模时，应该根据通用语言来命名事件，如果事件由聚合上的命令操作产生，那么通常根据操作方法的名字命名领域事件，事件的名字表明了聚合上的命令方法执行成功后所发生的事情。

领域事件可以由本地限界上下文消费、也可以由外部的限界上下文消费。



#### 模块：

模块表示了一个命名的容器（在Java中可以是一个包名），用于组织领域中内聚在一起的类，将类放在不同模块中的目的在于达到松耦合性，通常，对于一个或一组内聚的聚合来说，我们都应该相应的创建一个模块，模块名应该反映出他们在领域中的概念。

当通用语言中的术语非常模糊时，不清楚如何划分上下文边界，可以先将他们放在一起，使用模块对进行进行划分，而不是限界上下文。



#### 工厂

工厂提供创建对象的接口，负责复杂对象和聚合的创建，该接口封装了创建过程中的复杂操作过程。

工厂可以是一个单独的工厂对象，只用于创建某种聚合的对象；工厂方法也可以放在聚合根上，表达通用语言；复杂情况下也可以由领域服务扮演工厂的角色。



#### 资源库

资源库提供了对持久化机制的抽象，通常我们将聚合实例存放在资源库中，之后再通过该资源库获取实例，一般由应用层来访问资源库获取领域对象，持久化机制的事物管理一般也放在应用层中进行管理。

资源库一般使用仓储模式，仓储接口放在领域层中，仓储实现放在基础层，通过依赖倒置实现应用层对基础资源库的解耦。



#### 应用服务

应用服务是领域模型的直接客户，负责协调用例任务，管理事务，并执行一些必要的安全授权。不同于领域服务，应用服务只是很薄的一层，用来协调多个领域服务和领域对象完成服务编排和组合，协作完成业务操作，不处理业务逻辑。应用层也用来调用其它微服务，完成微服务间的服务编排和组合。



## 思考





大家日常用到的也都是贫血模型，我也觉得贫血模型有存在的必要性

通过这种方式，可以让建模的人看清业务模型，提升认识深度。

是内功，架构本来就很难证明他带来的直接效率

需要对DDD有较深入的研究，就目前所从事过的公司来看，似乎没有一家真正严格按照DDD进行项目代码设计的。

要求从分析阶段，产品经理、项目经理、架构师以及开发工程师就使用统一的模型语言来进行沟通，并且他们都懂一些代码、产品和建模相关的知识，事实上这在国内很难实施，国内的产品经理约等于需求整理工，对其计算机基础的要求是少之又少。









领域建模工作记录：





领域建模整体分三大块：战略建模、架构、战术建模。

\- 战略建模涉及通用语言、领域、限界上下文、上下文映射

\- 架构主要涉及架构模式，顺带提到架构风格

\- 战术建模涉及领域模型抽象，简单来讲是在OOP+UML基础上，结合领域驱动设计思想进行设计

考虑到大家对业务建模不熟，我选择先从战术建模入手，引导设计，以便大家更好的吸收、消化。

建模路径：

1、业务熟悉：形式不限，业务串讲、阅读代码、熟悉产品等

2、提炼概念模型：寻找关键对象，建立关系，产出实体关系图

3、泛化领域模型：以实体关系图为基础，设计出领域模型（实体、值对象、聚合、领域服务、资源库、工厂、领域事件、模块）+应用服务

4、细化类图：细化领域模型类图，确定属性、行为

5、确定顺序图：以应用服务为基础确定类调用顺序







前面很多讨论更多是有关定位，是顶层架构，是宏观的自顶向下的设计理念

事件风暴是从业务场景和细节出发，是微观的自底向上的归纳方法

自顶向下和自底向上，结合中观的领域驱动设计和微服务架构方法论，将宏观和微观连接起来，使二者相互印证，融为一体





自上而下，由业务愿景决定业务模式，结合行业通用分析模型，通过宏观的自顶向下的架构演绎，推演出顶层架构。

自下而上，从业务场景的细节逻辑出发，结合业务分析方法（事件风暴、领域事件、四色模型、词法分析等），通过微观的自底向上的归纳方法，总结出领域模型。

自顶向下的宏观演绎和自底向上的微观归纳，结合中观的领域驱动设计和微服务架构方法论，将宏观和微观连接起来，使二者相互印证，互证成立，融为一体，最终定型顶层架构设计、战略分析模型、战术领域模型。











