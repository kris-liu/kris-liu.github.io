---
title: 领域驱动设计学习
date: 2021-02-13 00:00:00
categories: 架构
tags: [架构,DDD]
---





### 为什么要用DDD：

微服务的边界

可以很好地实现微服务内部和外部的“高内聚、低耦合”。于是越来越多的人开始把DDD作为微服务设计的指导思想。

微服务是技术实现，DDD是建设方法论

DDD 方法建立的领域模型，可以清晰地划分微服务的逻辑边界和物理边界

DDD是一种处理高度复杂领域的设计思想，它试图分离技术实现的复杂性，并围绕业务概念构建领域模型来控制业务的复杂性，以解决软件难以理解，难以演进的问题。DDD不是架构，而是一种架构设计方法论，它通过边界划分将复杂业务领域简单化，帮我们设计出清晰的领域和应用边界，可以很容易地实现架构演进。

用DDD战略设计和事件风暴带你完成领域建模和企业级中台业务建模，了解事件风暴以及用事件风暴构建领域模型的过程。

设计出准确表达业务意图的软件模型

1.领域专家与开发这一起工作，开发出来的软件能准确的比传达业务规则
2.帮助业务人员自我提高
3.知识集中
4.设计就是代码，代码就是设计
5.战略设计帮我们理解那些投入是重要的，战术设计帮我们创建DDD模型中的各个部件
业务人员所想的映射到开发者所理解的，增加沟通和开发成本



### 如何帮助我们

DDD关注业务战略，战略设计帮我定一不同团队之间的组织关系，用于清楚的解纷不同系统和业务的关注点，保护每个业务层面的服务。指导我们如何实现面向服务的架构
战术设计是开发人员能够按照领域专家的思维模型开发软件。



### 什么是领域模型

领域模型是关于某个特定领域的软件模型，通常，领域模型通过对象模型来实现，这些对象同时包含了数据和行为，并且准确表达了业务含义


通用语言和限界上下文沟通了DDD的两大支柱，相辅相成。通用语言作用于某个限界上下文之内
通过上下文映射图对限界上下文进行集成
领域模型把通用语言表达成软件模型



### 价值

业务得到准确的定义和理解
清晰的模型边界
更好的企业架构




### DDD与微服务

DDD 是一种架构设计方法，微服务是一种架构风格，两者从本质上都是为了追求高响应力，而从业务视角去分离应用系统建设复杂度的手段。两者都强调从业务出发，其核心要义是强调根据业务发展，合理划分领域边界，持续调整现有架构，优化现有代码，以保持架构和代码的生命力，也就是我们常说的演进式架构。
DDD 主要关注：从业务领域视角划分领域边界，构建通用语言进行高效沟通，通过业务抽象，建立领域模型，维持业务和代码的逻辑一致性。
微服务主要关注：运行时的进程间通信、容错和故障隔离，实现去中心化数据管理和去中心化服务治理，关注微服务的独立开发、测试、构建和部署。
微服务架构 扩展性、弹性伸缩能力、小规模团队的敏捷开发，快速响应需求和业务的迅速变化



### 领域模型设计与数据模型设计



### 战略设计和战术设计：

战略设计主要从业务视角出发，建立业务领域模型，划分领域边界，建立通用语言的限界上下文，限界上下文可以作为微服务设计的参考边界。
战术设计则从技术视角出发，侧重于领域模型的技术实现，完成软件开发和落地，包括：聚合根、实体、值对象、领域服务、应用服务和资源库等代码逻辑的设计和实现。

DDD 战略设计会建立领域模型，领域模型可以用于指导微服务的设计和拆分。事件风暴是建立领域模型的主要方法，它是一个从发散到收敛的过程。它通常采用用例分析、场景分析和用户旅程分析，尽可能全面不遗漏地分解业务领域，并梳理领域对象之间的关系，这是一个发散的过程。事件风暴过程会产生很多的实体、命令、事件等领域对象，我们将这些领域对象从不同的维度进行聚类，形成如聚合、限界上下文等边界，建立领域模型，这就是一个收敛的过程。

在战略设计中我们建立了领域模型，划定了业务领域的边界，建立了通用语言和限界上下文，确定了领域模型中各个领域对象的关系。到这儿，业务端领域模型的设计工作基本就完成了，这个过程同时也基本确定了应用端的微服务边界。

通过 DDD 战略设计可以建立领域模型，划定领域边界，解决微服务设计过程中，边界难以划定的难题

战略建模
限界上下文 上下文映射图

战术建模 
战术设计的重要模式是聚合

限界上下文为图案对创建了一个模型边界，成员在边界内部为特定的业务领域创建解决方案，单个界限上下文中团队共享一套通用语言，不同团队各自负责一个限界上下文。使用上下文映射图在战略层面对限界上下文进行集成，在边界内部，团队成员使用战术建模工具：聚合，实体，指对象，领域服务，领域事件等 

战术建模比战略建模复杂，核心的业务子域更适合做战术设计，在团队成员有能力持续实施战术设计时





战略设计采用的方法是事件风暴

领域建模是通过对业务和问题域进行分析，建立领域模型。向上通过限界上下文指导微服务边界设计，向下通过聚合指导实体对象设计。

领域建模是一个收敛的过程，分三步：第一步找出领域实体和值对象等领域对象；第二步找出聚合根，根据实体、值对象与聚合根的依赖关系，建立聚合；第三步根据业务及语义边界等因素，定义限界上下文。

通过战略设计，我们建立了领域模型，划分了微服务边界。



战术设计是根据领域模型进行微服务设计的过程。





将领域逐级分解为大小合适的子域，针对子域采用事件风暴，划分聚合和限界上下文，初步确定子域内的领域模型。





### 事件风暴：

在事件风暴中，我们会根据一些业务操作和行为找出实体（Entity）或值对象（ValueObject），进而将业务关联紧密的实体和值对象进行组合，构成聚合，再根据业务语义将多个聚合划定到同一个限界上下文（Bounded Context）中，并在限界上下文内完成领域建模。

事件风暴正是 DDD 战略设计中经常使用的一种方法，它可以快速分析和分解复杂的业务领域，完成领域建模



## 架构：

### 分层架构：

分层架构一般分为用户接口层、应用层、领域层和基础层四层，每个层都应该具有良好的内聚性，并且只依赖比自身更低的层。分层架构分两种，松散分层架构和严格分层架构，松散分层架构允许任意上层与任意下层发生耦合；严格分层架构则只能访问其下方的层，一般来说我们会使用严格分层架构。

* 用户接口层：负责向用户显示信息和解释用户命令，这一层聚集了接口适配相关的功能。	

* 应用层：应用层指应用服务，用来协调多个领域服务和领域对象完成服务编排和组合，协作完成业务操作，不处理业务逻辑。

* 领域层：领域层实现领域模型的业务逻辑，该层包含聚合根、实体、值对象、领域服务等领域模型中的领域对象。
* 基础层：基础层为其他层提供技术基础服务，比如数据库、缓存、消息等。基础层一般会贯穿所有其他层，其他层遵循严格分层架构。



### 六边形架构（端口与适配器）：
对于每种外界类型，都有一个适配器与之相对应。不同客户可以通过各种方式与系统交互，只需要添加一个新的适配器将客户输入转化成能被系统API理解的参数就行，系统输出也都有对应的适配器负责完成相应的转化功能。六边形每条边代表不同类型的端口，要么处理输入，要么处理输出。

* 端口一般指：http，消息机制

* 适配器一般指：servlet，消息监听器

  

### CQRS

CQRS旨在解决数据显示复杂性问题，将领域模型一分为二，命令模型和查询模型分开存储。

* 如果一个方法修改了对象的状态，该方法便是一个命令。
* 如果一个方法返回了数据，该方法便是一个查询。
  





## 核心概念：

主要讲解DDD的核心知识体系，具体包括：领域、子域、核心域、通用域、支撑域、限界上下文、实体、值对象、聚合和聚合根等概念。



### 领域、子域、核心域、通用域、支撑域： 战略设计

领域的核心思想就是将问题域逐级细分，来降低业务理解和系统实现的复杂度。通过领域细分，逐步缩小微服务需要解决的问题域，构建合适的领域模型，而领域模型映射成系统就是微服务了。

DDD中一个领域被分成若干子域，并分别定义为核心域、支撑域或通用域，通过领域划分，区分不同子域在公司内的不同功能属性和重要性，从而公司可对不同子域采取不同的资源投入和建设策略，其关注度也会不一样。

* 核心域：业务成功的主要促成因素，主要关注的
* 支撑域：专注于业务的某个方面
* 通用域：被用于整个业务系统。



### 通用语言：

在事件风暴过程中，通过团队交流达成共识的，能够简单、清晰、准确描述业务涵义和规则的语言就是通用语言。
通用语言的价值：解决交流障碍这个问题，使领域专家和开发人员能够协同合作，从而确保业务需求的正确表达。

通用语言作用于某个限界上下文之内

项目成员通过通用语言表达软件模型



### 限界上下文：

通过事件风暴来划分限界上下文。

领域边界就是通过限界上下文来定义的。限界上下文是微服务设计和拆分的主要依据，一个限界上下文理论上就可以设计为一个微服务。




### 上下文映射图
用于表达项目之间的集成关系

限界上下文之间关系，不同团队之间的关系存在多种组织模式和集成模式，常见的比如：客户方供应方开发。

1. 客户方（Downstream 下游）-供应方（Upstream 上游）开发：表示上下游团队的关系，上游团队可以独立于下游团队完成开发。
   

集成使用的技术：

1. 开放主机（OHS）：定义一种协议让其他系统通过该协议访问你的服务。
2. 发布语言（PL）：两个限界上下文之间翻译模型需要的公用语言，一般指编码方式，比如xml，json等，一般与开放主机共同使用。
3. 防腐层（ACL）：该层作为上游系统的代理向系统提供服务。客户端领域服务访问上游开放主机服务，远程服务以发布语言形式返回，防腐层将上游返回的发布语言翻译成本地上下文的领域对象，客户端领域服务service作为防腐层接口，委派给Adapter，Adapter先访问远程开放主机，然后由Adapter通过Translator将发布语言翻译成本地领域对象。



### 实体:

实体一般对应业务对象，它具有业务属性和业务行为，一个实体拥有一个固定的身份标识，可以对实体进行多次修改，由于身份标识不变，他们依然是同一个实体。，
实体类通常采用充血模型，与这个实体相关的所有业务逻辑都在实体类的方法中实现，跨多个实体的领域逻辑则在领域服务中实现。

唯一标识和可变性是实体和值对象的区别。



### 值对象：

值对象用于度量和描述事物，一般用来对实体的状态和特征进行描述。一个值对象可以只处理单个属性也可以处理一组相关联的属性。值对象不可变，只能整体替换，值对象的行为方法属于无副作用函数，不会改变内部属性。



### 聚合：

聚合就是由业务和逻辑紧密关联的实体和值对象组合而成的，聚合对象树的根节点就是聚合根。

聚合的原则：

1. 在一致性边界内建模不变条件。不变条件表示一个业务规则，该规则总是保持一致的；一致性指事务一致性，一个事务中之修改一个聚合。
2. 设计小聚合，可以提高伸缩性、性能、可用性。
3. 通过唯一标识引用其他聚合
4. 聚合的边界外使用最终一致性



### 领域服务：

领域中的服务表示一个无状态的操作，用于实现特定于某个领域的任务，当操作不适合放到聚合和值对象上时，最好的方式就是使用领域服务了。当业务功能单一实体和值对象无法实现时，就可以引入领域服务，领域服务可以用来组合多个实体或者值对象，实现复杂的业务逻辑。



### 领域事件：

表示领域专家关心的发生在领域中的一些事件，有很强业务逻辑的地方，一般就是业务关注的发生的事件，一个领域事件将导致进一步的业务操作。在建模时，应该根据通用语言来命名事件，如果事件由聚合上的命令操作产生，那么通常根据操作方法的名字命名领域事件，事件的名字表明了聚合上的命令方法执行成功后所发生的事情。

领域事件可以由本地限界上下文消费、也可以由外部的限界上下文消费。



### 模块：

模块表示了一个命名的容器（在Java中可以是一个包名），用于组织领域中内聚在一起的类，将类放在不同模块中的目的在于达到松耦合性，通常，对于一个或一组内聚的聚合来说，我们都应该相应的创建一个模块，模块名应该反映出他们在领域中的概念。

当通用语言中的术语非常模糊时，不清楚如何划分上下文边界，可以先将他们放在一起，使用模块对进行进行划分，而不是限界上下文。



### 工厂

工厂应该提供一个创建对象的接口，该接口封装了所有创建对象的复杂操作过程。工厂可以是一个单独的工厂对象，只用于创建某种聚合的对象；工厂方法也可以放在聚合根上，表达通用语言；复杂情况下也可以由领域服务扮演工厂的角色。



### 资源库

资源库提供了对持久化机制的抽象，通常我们将聚合实例存放在资源库中，之后再通过该资源库获取相同的实例。持久化机制的事物管理一般放在应用层中管理。



### 应用服务

应用服务是领域模型的直接客户，负责协调用例任务，管理事务，并执行一些必要的安全授权。不同于领域服务，应用服务只是很薄的一层，用来协调多个领域服务和领域对象完成服务编排和组合，协作完成业务操作，不处理业务逻辑。











领域建模工作记录：





领域建模整体分三大块：战略建模、架构、战术建模。

\- 战略建模涉及通用语言、领域、限界上下文、上下文映射

\- 架构主要涉及架构模式，顺带提到架构风格

\- 战术建模涉及领域模型抽象，简单来讲是在OOP+UML基础上，结合领域驱动设计思想进行设计

考虑到大家对业务建模不熟，我选择先从战术建模入手，引导设计，以便大家更好的吸收、消化。

建模路径：

1、业务熟悉：形式不限，业务串讲、阅读代码、熟悉产品等

2、提炼概念模型：寻找关键对象，建立关系，产出实体关系图

3、泛化领域模型：以实体关系图为基础，设计出领域模型（实体、值对象、聚合、领域服务、资源库、工厂、领域事件、模块）+应用服务

4、细化类图：细化领域模型类图，确定属性、行为

5、确定顺序图：以应用服务为基础确定类调用顺序





经过这几次讨论，把清结算边界和职责定出来，尝试的画一下清算的流程、结算的流程





前面很多讨论更多是有关定位，是顶层架构，是宏观的自顶向下的设计理念

事件风暴是从业务场景和细节出发，是微观的自底向上的归纳方法

自顶向下和自底向上，结合中观的领域驱动设计和微服务架构方法论，将宏观和微观连接起来，使二者相互印证，融为一体





自上而下，由业务愿景决定业务模式，结合行业通用分析模型，通过宏观的自顶向下的架构演绎，推演出顶层架构。

自下而上，从业务场景的细节逻辑出发，结合业务分析方法（事件风暴、领域事件、四色模型、词法分析等），通过微观的自底向上的归纳方法，总结出领域模型。

自顶向下的宏观演绎和自底向上的微观归纳，结合中观的领域驱动设计和微服务架构方法论，将宏观和微观连接起来，使二者相互印证，互证成立，融为一体，最终定型顶层架构设计、战略分析模型、战术领域模型。





事件风暴

有很强业务逻辑的地方，一般就是业务关注的发生的事件

在此之后的战术建模，需要找一个具体的模块，用事件风暴的建模方法，提炼出事件、命令、角色、聚合，进而细化领域模型、服务API、时序图、类图





1、统一语言，提升日常产研工作沟通效率

2、理清系统边界和职责，指导架构设计

3、优雅的系统设计，提升系统扩展性和可维护性

4、切实提升个人的架构设计能力，思考深度和广度有明显提升



是内功，架构本来就很难证明他带来的直接效率



通过这种方式，可以让建模的人看清业务模型，提升认识深度。





通用语言 便于交流

明确服务之间的关系（界限上下文），梳理界限上下文之间的交互的流程 确认领域的行为，便于设计系统的交互 边界和交互更清晰，可以弱化收银台的感知，只要按约定发通知就可以了

系统内部流程的梳理，提高扩展性和可维护性，能力上更专业，而不是总是业务自己想怎么样就是怎么样。

再就是对于个人来讲 提升个人的架构设计能力。



1、统一语言，提升日常产研工作沟通效率 

2、理清系统边界和职责，指导架构设计 

3、优雅的系统设计，提升系统扩展性和可维护性 

4、切实提升个人的架构设计能力，思考深度和广度有明显提升