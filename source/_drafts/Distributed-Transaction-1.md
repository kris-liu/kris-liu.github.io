---
title: 从零开始写一个分布式事务框架(一)
date: 2020-02-16 22:16:26
categories: 架构
tags: [架构,Transaction]
---

在工作的过程中，经常会遇到一些分布式环境下数据一致性的问题，尤其是在做一些交易、支付、账户等业务的时候，其中不可避免的会涉及到一些分布式事务领域的技术方案，在之前的工作中也曾经使用过分布式事务框架来解决问题，一直对这一领域的问题十分感兴趣，所以就想着自己动手造个轮子，从零开始写一个分布式事务框架，以此加深自己对分布式事务的理解和在系统架构与实现上的经验积累，在这里也记录一下自己造轮子过程中的思考。



## 架构设计



### 方案选型

在之前的文章（[分布式事务](http://blogxin.cn/2018/04/23/Distributed-Transaction)）中，对分布式事务相关概念和解决方案做了介绍，又调研了一些当下的分布式事务框架原理，综合考虑后，选择TCC分布式事务模型作为本次的技术实现方案，虽然该方案业务侵入性较高，但是该方案适用场景广泛，隔离性和性能都可以做极致优化，非常灵活。



##### TCC分布式事务模型介绍

TCC分布式事务模型主要解决了分布式应用架构场景下跨服务的事务问题。作为保证分布式一致性的一种解决方案。使用2PC原子提交协议来保证分布式事务原子性。隔离性通过业务逻辑来进行资源隔离，从底层数据库资源层面的加锁过渡为上层业务层面的加锁，提高了业务并发能力。一致性方面实现了最终一致性。TCC分布式事务模型是基于BASE理论的柔性事物，牺牲了强一致性获得了更高的可用性。

TCC分布式事务模型主要包括三部分：

* 主业务服务：主业务服务为整个业务活动的发起方，服务的编排者，负责发起并完成整个业务活动。

* 从业务服务：从业务服务是整个业务活动的参与方，负责提供TCC模型的业务操作，需要实现初步操作（Try）、确认操作（Confirm）、取消操作（Cancel）三个接口来完成业务操作，供主业务服务调用。

  * 初步操作（Try）：完成所有业务检查，预留必须的业务资源，通过业务手段锁定预留资源。比如支付时，从余额中将该笔支付金额置为冻结状态。

  * 确认操作（Confirm）：真正执行的业务逻辑，不作任何业务检查，只使用Try阶段预留的业务资源。因此，只要Try操作成功，Confirm必须能成功。另外，Confirm操作需满足幂等性，保证一笔分布式事务有且只能成功一次。

  * 取消操作（Cancel）：释放Try阶段预留的业务资源。同样的，Cancel操作也需要满足幂等性。

* 业务活动管理器：业务活动管理器管理控制整个业务活动，包括记录维护TCC全局事务的事务状态和每个从业务服务的子事务状态，并在业务活动提交时调用所有从业务服务的Confirm操作，在业务活动取消时调用所有从业务服务的Cancel操作。

![TCC](/Users/xin/work/project/kris/kris-liu.github.io/source/_posts/Distributed-Transaction/TCC.png)



### 实现思路及原理





TCC分布式事务是通过主业务服务的本地事物的提交来决定整体分布式事务是否提交的，并在调用从业务服务前记录事物日志，一定程度上将分布式事务转化为本地事务，并基于事物日志提供一定的补偿机制，来实现分布式事务的最终一致性。



![TCC](/Users/xin/work/project/kris/kris-liu.github.io/source/_drafts/Distributed-Transaction-1/Distributed-Transaction.jpg)





一个完整的TCC分布式事务流程如下：

1.	主业务服务首先开启一个业务本地事务；
2.	主业务服务向业务活动管理器申请启动分布式事务主业务活动，挂起业务事物，新起一个本地事物来记录主事物活动（保证无论业务事物是否提交，主事物活动一定记录下来），然后回到业务事物来更新主事物活动的状态（主要是保证业务事务的提交和主事物活动的状态更新在一个本地事物中完成，在这个过程中锁定了主事物活动记录，最终通过主事物活动的状态及锁定情况可以判断分布式事物的执行情况）；
3.	针对要调用的从业务服务，主业务活动先向业务活动管理器注册从业务活动，然后挂起业务事物，新起一个本地事物来记录从事务活动，然后再调用从业务服务的Try接口（保证无论是否完成调用从业务Try接口，从事务活动一定已被记录）；
4.	当所有从业务服务的Try接口调用成功，主业务服务提交本地事务；若调用失败，主业务服务回滚本地事务；
5.	主业务服务本地事物结束后，根据本地事物的提交或回滚来触发调用所有从业务服务的Confirm接口或Cancel接口，全部调用完成后删除所有事务活动记录。由于Try接口调用完成即可以保证二阶段一定可以Confirm，所以二阶段Confirm在任何时机都可以调用，所以本地事物提交后，二阶段Confirm可以进行一定的异步化，甚至在业务高峰期可以不进行二阶段Confirm，只实时处理Cancel的情况，高峰期过了之后再统一进行二阶段Confirm，可以起到一定的消峰作用；
6.	所有从业务服务的Confirm或Cancel操作完成后，全局事务结束。如果本地事物提交后主业务服务因为故障等原因没有出发二阶段提交，或二阶段提交失败，那么此时需要一个scan server来扫描本地分布式事物活动表中未提交的事物，根据主事物活动的状态及主事物活动记录的锁定情况可以判断主分布式事物的执行情况是否需要进行补偿提交，然后根据从事务记录对所有相应的从业务服务进行Confirm或Cancel，整体通过scan server周期性扫描来进行补偿操作。



### 模块设计



### 组件依赖